#include <Eigen/Eigen>
#include "config.hpp"

using namespace std;
using namespace Eigen;

// constructor
lateralController50::lateralController50() {
    // initialize member variables 
    // m_d   = 0.135L;   // 2*d = distance between left and right wheels
    // m_l   = 0.42L;    // l = distance between front and read wheels 
    // m_vx  = 2.2L;     // vehicle longitudinal speed is 2.2m/s to simulate ~80km/h in reality
    // m_LL  = 0.55L;    // look-ahead distance is 0.25s*vx
    // m_l_r = 0.21L;    // distance from CG to rear axle (m)
    m_d   = 1.628L;   // 2*d = distance between left and right wheels  
    m_l   = 2.995L;    // l = distance between front and rear wheels 
    m_vx  = 13.88889L;     // vehicle longitudinal speed is 5.55556m/s (20 km/hr)
    m_LL  = 5.5L;    // look-ahead distance is 0.25s*vx
    m_l_r = 1.2975L;    // distance from CG to rear axle (m)
    m_z1    = 0.0L;         // z1 is vy
    m_z2    = 0.0L;         // z2 is yaw rate
    m_z3    = 0.0L;         // z3 is yL
    m_z4    = 0.0L;         // z4 is epsilon_L
    m_z5    = 0.0L;         // z5 is curvature at lookahead distance KL (which is K_ref of CoG)
    fill(m_input.begin(), m_input.end(), 0.0L); // m_input is the input of the last sampling period.

    m_desired_steering_angle = 0.0L;
    m_steering_angle_left    = 0.0L;
    m_steering_angle_right   = 0.0L;

    // controller design time parameters
    // Eigen::Matrix<typename Scalar, int RowsAtCompileTime, int ColsAtCompileTime>
	///// VALUES ARE CONSIDERING ACTUATE DELAY //////////
/////////////////////////////////////////////////////////////// v0 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[0] <<   
0.68394125179038001,   -0.50469569680628912,   0,   0,   0,   1.8344030848628483,
     -0.017622779064995642,   0.76204221447773546,   0,   0,   0,   1.2381213145506385,
     -0.034844135184427756,   -0.21656850528145191,   1,   0.625,   0.1953125,   -0.21472642726492033,
     0.00044389000156342973,   -0.039350449411834472,   0,   1,   0.625,   -0.029322839232682182,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    m_K2c[0] <<
-0.026700589945090891,   -0.21058742754106646,   0.24185856600630501,   1.3798934226662904,   1.9450838658816487e-14,   -0.35078808495101099; // Q = 7.5, R=200 
// -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
// -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
//-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.5
   

    m_T[0] <<
1.5623353305516119e-16,   -2.7885679876327174e-16,   1.6688039838896884e-15,   -1.4252488078625447e-14,   1,   0,
     -0.0044833004709295462,   0.0079934772190918199,   -0.12764621405085996,   0.99177741876759684,   1.4557799410397365e-14,   0,
     0.37081571333704633,   -0.66318216975759603,   -0.64567557565771327,   -0.076080006946801268,   0,   0,
     -0.4265862987384999,   0.50012326913814187,   -0.74664941007110996,   -0.10205637577157149,   0,   0,
     0.82492407922657485,   0.5567784386128225,   -0.096561656355026282,   -0.013186369099536136,   0,   0,
     0,   0,   0,   0,   0,   1;
   
    
    m_Gamma_aug[0] <<
0,
     0,
     -0,
     -0,
     0,
     1;
	 
/////////////////////////////////////////////////////////////// v1 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[1] <<   
0.80792437410860463,   -0.32456193544483858,   0,   0,   0,   1.21142341744453,
     -0.011332934513699816,   0.85814988577894158,   0,   0,   0,   0.73571105184472918,
     -0.021656235776514279,   -0.12725181208985945,   1,   0.34722222222222227,   0.060281635802469154,   -0.069476429682567453,
     0.00015077768163936463,   -0.023171726786256237,   0,   1,   0.34722222222222227,   -0.0094690301420210597,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[1] <<
-0.035357029958590802,   -0.19487134933835665,   0.27980395963813398,   1.3792300886808009,   3.6472659351993714e-14,   -0.20049042528237065; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[1] <<
9.6023043032536504e-17,   -1.7785659013266897e-16,   3.570060913560269e-15,   -2.7561286586319511e-14,   1.0000000000000002,   0,
     -0.00021934666699925139,   0.00034699237748805174,   -0.13519025103808821,   0.99081957363971584,   2.7450264283856995e-14,   0,
     0.34164314375037214,   -0.62909634752691301,   -0.69185435014608498,   -0.094102635672964674,   0,   0,
     -0.39307893962392243,   0.57917879685666673,   -0.70757623444498785,   -0.096833573436324469,   0,   0,
     0.85367960116166208,   0.51844921293821189,   -0.048959438894342025,   -0.0066727436160019856,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[1] <<
    0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// v2 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[2] <<   
0.80792437410860463,   -0.32456193544483858,   0,   0,   0,   1.21142341744453,
     -0.011332934513699816,   0.85814988577894158,   0,   0,   0,   0.73571105184472918,
     -0.021656235776514279,   -0.12725181208985945,   1,   0.34722222222222227,   0.060281635802469154,   -0.069476429682567453,
     0.00015077768163936463,   -0.023171726786256237,   0,   1,   0.34722222222222227,   -0.0094690301420210597,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[2] <<
-0.035357029958590802,   -0.19487134933835665,   0.27980395963813398,   1.3792300886808009,   3.6472659351993714e-14,   -0.20049042528237065; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[2] <<
9.6023043032536504e-17,   -1.7785659013266897e-16,   3.570060913560269e-15,   -2.7561286586319511e-14,   1.0000000000000002,   0,
     -0.00021934666699925139,   0.00034699237748805174,   -0.13519025103808821,   0.99081957363971584,   2.7450264283856995e-14,   0,
     0.34164314375037214,   -0.62909634752691301,   -0.69185435014608498,   -0.094102635672964674,   0,   0,
     -0.39307893962392243,   0.57917879685666673,   -0.70757623444498785,   -0.096833573436324469,   0,   0,
     0.85367960116166208,   0.51844921293821189,   -0.048959438894342025,   -0.0066727436160019856,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[2] <<
    0,
     0,
     -0,
     -0,
     0,
     1;
  
/////////////////////////////////////////////////////////////// v3 ////////////////////////////////////////////////////////////////////////////
     m_phi_aug[3] <<   
0.68394125179038001,   -0.50469569680628912,   0,   0,   0,   1.8344030848628483,
     -0.017622779064995642,   0.76204221447773546,   0,   0,   0,   1.2381213145506385,
     -0.034844135184427756,   -0.21656850528145191,   1,   0.625,   0.1953125,   -0.21472642726492033,
     0.00044389000156342973,   -0.039350449411834472,   0,   1,   0.625,   -0.029322839232682182,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    m_K2c[3] <<
-0.026700589945090891,   -0.21058742754106646,   0.24185856600630501,   1.3798934226662904,   1.9450838658816487e-14,   -0.35078808495101099; // Q = 7.5, R=200 
// -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
// -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
//-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.5
   

    m_T[3] <<
1.5623353305516119e-16,   -2.7885679876327174e-16,   1.6688039838896884e-15,   -1.4252488078625447e-14,   1,   0,
     -0.0044833004709295462,   0.0079934772190918199,   -0.12764621405085996,   0.99177741876759684,   1.4557799410397365e-14,   0,
     0.37081571333704633,   -0.66318216975759603,   -0.64567557565771327,   -0.076080006946801268,   0,   0,
     -0.4265862987384999,   0.50012326913814187,   -0.74664941007110996,   -0.10205637577157149,   0,   0,
     0.82492407922657485,   0.5567784386128225,   -0.096561656355026282,   -0.013186369099536136,   0,   0,
     0,   0,   0,   0,   0,   1;
   
    
    m_Gamma_aug[3] <<
0,
     0,
     -0,
     -0,
     0,
     1;
   
/////////////////////////////////////////////////////////////// v4 ////////////////////////////////////////////////////////////////////////////
 m_phi_aug[4] <<   
0.80792437410860463,   -0.32456193544483858,   0,   0,   0,   1.21142341744453,
     -0.011332934513699816,   0.85814988577894158,   0,   0,   0,   0.73571105184472918,
     -0.021656235776514279,   -0.12725181208985945,   1,   0.34722222222222227,   0.060281635802469154,   -0.069476429682567453,
     0.00015077768163936463,   -0.023171726786256237,   0,   1,   0.34722222222222227,   -0.0094690301420210597,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[4] <<
-0.035357029958590802,   -0.19487134933835665,   0.27980395963813398,   1.3792300886808009,   3.6472659351993714e-14,   -0.20049042528237065; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[4] <<
9.6023043032536504e-17,   -1.7785659013266897e-16,   3.570060913560269e-15,   -2.7561286586319511e-14,   1.0000000000000002,   0,
     -0.00021934666699925139,   0.00034699237748805174,   -0.13519025103808821,   0.99081957363971584,   2.7450264283856995e-14,   0,
     0.34164314375037214,   -0.62909634752691301,   -0.69185435014608498,   -0.094102635672964674,   0,   0,
     -0.39307893962392243,   0.57917879685666673,   -0.70757623444498785,   -0.096833573436324469,   0,   0,
     0.85367960116166208,   0.51844921293821189,   -0.048959438894342025,   -0.0066727436160019856,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[4] <<
    0,
     0,
     -0,
     -0,
     0,
     1;
  

/////////////////////////////////////////////////////////////// v5 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[5] <<   
0.80792437410860463,   -0.32456193544483858,   0,   0,   0,   1.21142341744453,
     -0.011332934513699816,   0.85814988577894158,   0,   0,   0,   0.73571105184472918,
     -0.021656235776514279,   -0.12725181208985945,   1,   0.34722222222222227,   0.060281635802469154,   -0.069476429682567453,
     0.00015077768163936463,   -0.023171726786256237,   0,   1,   0.34722222222222227,   -0.0094690301420210597,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[5] <<
-0.035357029958590802,   -0.19487134933835665,   0.27980395963813398,   1.3792300886808009,   3.6472659351993714e-14,   -0.20049042528237065; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[5] <<
9.6023043032536504e-17,   -1.7785659013266897e-16,   3.570060913560269e-15,   -2.7561286586319511e-14,   1.0000000000000002,   0,
     -0.00021934666699925139,   0.00034699237748805174,   -0.13519025103808821,   0.99081957363971584,   2.7450264283856995e-14,   0,
     0.34164314375037214,   -0.62909634752691301,   -0.69185435014608498,   -0.094102635672964674,   0,   0,
     -0.39307893962392243,   0.57917879685666673,   -0.70757623444498785,   -0.096833573436324469,   0,   0,
     0.85367960116166208,   0.51844921293821189,   -0.048959438894342025,   -0.0066727436160019856,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[5] <<
    0,
     0,
     -0,
     -0,
     0,
     1;
  
    
/////////////////////////////////////////////////////////////// v6 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[6] <<   
0.80792437410860463,   -0.32456193544483858,   0,   0,   0,   1.21142341744453,
     -0.011332934513699816,   0.85814988577894158,   0,   0,   0,   0.73571105184472918,
     -0.021656235776514279,   -0.12725181208985945,   1,   0.34722222222222227,   0.060281635802469154,   -0.069476429682567453,
     0.00015077768163936463,   -0.023171726786256237,   0,   1,   0.34722222222222227,   -0.0094690301420210597,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[6] <<
-0.035357029958590802,   -0.19487134933835665,   0.27980395963813398,   1.3792300886808009,   3.6472659351993714e-14,   -0.20049042528237065; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[6] <<
9.6023043032536504e-17,   -1.7785659013266897e-16,   3.570060913560269e-15,   -2.7561286586319511e-14,   1.0000000000000002,   0,
     -0.00021934666699925139,   0.00034699237748805174,   -0.13519025103808821,   0.99081957363971584,   2.7450264283856995e-14,   0,
     0.34164314375037214,   -0.62909634752691301,   -0.69185435014608498,   -0.094102635672964674,   0,   0,
     -0.39307893962392243,   0.57917879685666673,   -0.70757623444498785,   -0.096833573436324469,   0,   0,
     0.85367960116166208,   0.51844921293821189,   -0.048959438894342025,   -0.0066727436160019856,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[6] <<
    0,
     0,
     -0,
     -0,
     0,
     1;
  
   
/////////////////////////////////////////////////////////////// v7 ////////////////////////////////////////////////////////////////////////////
m_phi_aug[7] <<   
0.80792437410860463,   -0.32456193544483858,   0,   0,   0,   1.21142341744453,
     -0.011332934513699816,   0.85814988577894158,   0,   0,   0,   0.73571105184472918,
     -0.021656235776514279,   -0.12725181208985945,   1,   0.34722222222222227,   0.060281635802469154,   -0.069476429682567453,
     0.00015077768163936463,   -0.023171726786256237,   0,   1,   0.34722222222222227,   -0.0094690301420210597,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[7] <<
-0.035357029958590802,   -0.19487134933835665,   0.27980395963813398,   1.3792300886808009,   3.6472659351993714e-14,   -0.20049042528237065; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[7] <<
9.6023043032536504e-17,   -1.7785659013266897e-16,   3.570060913560269e-15,   -2.7561286586319511e-14,   1.0000000000000002,   0,
     -0.00021934666699925139,   0.00034699237748805174,   -0.13519025103808821,   0.99081957363971584,   2.7450264283856995e-14,   0,
     0.34164314375037214,   -0.62909634752691301,   -0.69185435014608498,   -0.094102635672964674,   0,   0,
     -0.39307893962392243,   0.57917879685666673,   -0.70757623444498785,   -0.096833573436324469,   0,   0,
     0.85367960116166208,   0.51844921293821189,   -0.048959438894342025,   -0.0066727436160019856,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[7] <<
    0,
     0,
     -0,
     -0,
     0,
     1;
  
	 
/////////////////////////////////////////////////////////////// v8 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[8] <<   
0.71278250040210955,   -0.46527336465789865,   0,   0,   0,   1.7029138819631846,
     -0.016246244543155621,   0.7847829115855518,   0,   0,   0,   1.1189251481557208,
     -0.031846711224899862,   -0.19512883284687657,   1,   0.55555555555555558,   0.15432098765432101,   -0.17162998465516457,
     0.00035916683321570537,   -0.035483726209156158,   0,   1,   0.55555555555555558,   -0.023428528346724393,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[8] <<
-0.028697981997259953,   -0.20728428461608525,   0.25087863029946833,   1.3819234949303254,   -6.0841843617852185e-15,   -0.31420031167911749; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[8] <<
-3.7676025493871279e-17,   6.9063678387326632e-17,   -5.2041704279304213e-16,   4.3021142204224816e-15,   1,   0,
     -0.0033741920705349432,   0.006036961393799084,   -0.12947509363008697,   0.99155855603916876,   -4.5519144009631418e-15,   0,
     0.36328257488009763,   -0.6553906117171947,   -0.65726177079839043,   -0.080597031635237584,   0,   0,
     -0.41781853488286835,   0.52061874742315861,   -0.73769864985047773,   -0.10091825280224044,   0,   0,
     0.83273168399232333,   0.54715886267301972,   -0.083927747409461545,   -0.011456643856316548,   0,   0,
     0,   0,   0,   0,   0,   1;
  

    m_Gamma_aug[8] <<
0,
     0,
     -0,
     -0,
     0,
     1;


/////////////////////////////////////////////////////////////// origin ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[9] <<   
0.80792437410860463,   -0.32456193544483858,   0,   0,   0,   1.21142341744453,
     -0.011332934513699816,   0.85814988577894158,   0,   0,   0,   0.73571105184472918,
     -0.021656235776514279,   -0.12725181208985945,   1,   0.34722222222222227,   0.060281635802469154,   -0.069476429682567453,
     0.00015077768163936463,   -0.023171726786256237,   0,   1,   0.34722222222222227,   -0.0094690301420210597,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[9] <<
-0.035357029958590802,   -0.19487134933835665,   0.27980395963813398,   1.3792300886808009,   3.6472659351993714e-14,   -0.20049042528237065; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[9] <<
9.6023043032536504e-17,   -1.7785659013266897e-16,   3.570060913560269e-15,   -2.7561286586319511e-14,   1.0000000000000002,   0,
     -0.00021934666699925139,   0.00034699237748805174,   -0.13519025103808821,   0.99081957363971584,   2.7450264283856995e-14,   0,
     0.34164314375037214,   -0.62909634752691301,   -0.69185435014608498,   -0.094102635672964674,   0,   0,
     -0.39307893962392243,   0.57917879685666673,   -0.70757623444498785,   -0.096833573436324469,   0,   0,
     0.85367960116166208,   0.51844921293821189,   -0.048959438894342025,   -0.0066727436160019856,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[9] <<
    0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// 1 classifier ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[10] <<   
0.74301174761195976,   -0.42226330801771633,   0,   0,   0,   1.5559451883362971,
     -0.014744435174581204,   0.80835641187682827,   0,   0,   0,   0.99557646247979037,
     -0.028656443027834801,   -0.17311895085723894,   1,   0.4861111111111111,   0.1181520061728395,   -0.13295226750854111,
     0.00028163632370048518,   -0.031501232385698755,   0,   1,   0.4861111111111111,   -0.018140508169899046,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[10] <<
-0.030804050137703931,   -0.20357277451727346,   0.26020640554214947,   1.3825502967700507,   -3.0954116480415793e-14,   -0.27693268600392068; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[10] <<
-1.6084139228822458e-16,   2.9089144287786084e-16,   -2.7998436902265667e-15,   2.2676305277968822e-14,   1,   0,
     -0.002294781655814837,   0.0041097540687726024,   -0.13134140664343083,   0.99132602043907403,   -2.3175905639050143e-14,   0,
     0.35591111358533528,   -0.64710730117894388,   -0.66883193543184716,   -0.085107356520098015,   0,   0,
     -0.40930511396356506,   0.54062533347598662,   -0.72818957046292188,   -0.099667055521254128,   0,   0,
     0.84011388328420789,   0.5375495321236694,   -0.071785977157377764,   -0.0097947491194457417,   0,   0,
     0,   0,   0,   0,   0,   1;
  

    m_Gamma_aug[10] <<
0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// 2 classifier ////////////////////////////////////////////////////////////////////////////
       m_phi_aug[11] <<   
0.71278250040210955,   -0.46527336465789865,   0,   0,   0,   1.7029138819631846,
     -0.016246244543155621,   0.7847829115855518,   0,   0,   0,   1.1189251481557208,
     -0.031846711224899862,   -0.19512883284687657,   1,   0.55555555555555558,   0.15432098765432101,   -0.17162998465516457,
     0.00035916683321570537,   -0.035483726209156158,   0,   1,   0.55555555555555558,   -0.023428528346724393,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[11] <<
-0.028697981997259953,   -0.20728428461608525,   0.25087863029946833,   1.3819234949303254,   -6.0841843617852185e-15,   -0.31420031167911749; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[11] <<
-3.7676025493871279e-17,   6.9063678387326632e-17,   -5.2041704279304213e-16,   4.3021142204224816e-15,   1,   0,
     -0.0033741920705349432,   0.006036961393799084,   -0.12947509363008697,   0.99155855603916876,   -4.5519144009631418e-15,   0,
     0.36328257488009763,   -0.6553906117171947,   -0.65726177079839043,   -0.080597031635237584,   0,   0,
     -0.41781853488286835,   0.52061874742315861,   -0.73769864985047773,   -0.10091825280224044,   0,   0,
     0.83273168399232333,   0.54715886267301972,   -0.083927747409461545,   -0.011456643856316548,   0,   0,
     0,   0,   0,   0,   0,   1;
  

    m_Gamma_aug[11] <<
0,
     0,
     -0,
     -0,
     0,
     1;
}
// destructor
lateralController50::~lateralController50(){}

// class methods
void lateralController50::compute_steering_angles(long double the_yL, int the_it_counter, int the_pipe_version) {
    m_z3 = the_yL;
    m_z5 = 2 * m_z3 / ( pow( m_LL + m_l_r, 2 ) );   // curvature calculate

    Matrix<long double, 6, 1> zt_temp, zt;       // zt is the transferred state vector
    if (the_it_counter == 0){
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;
    } else {
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1];
    }

    // zt = m_T[the_pipe_version] * zt_temp;        

    // Matrix<long double, 6, 1> zt_temp_2;
    // zt_temp_2 << zt[1], 
    //              zt[2], 
    //              zt[3], 
    //              zt[4], 
    //              zt[5],
    //              zt[6];

    // calculate the desired steering angle 
    m_desired_steering_angle = m_K2c[the_pipe_version] * zt_temp;   
    // calculate left front tire steering angle according to desired steering angle                     
    m_steering_angle_left    = atan( m_l / (-m_d + m_l / tan(m_desired_steering_angle) ) );  
    // calculate right front tire steering angle according to desired steering angle 
    m_steering_angle_right   = atan( m_l / ( m_d + m_l / tan(m_desired_steering_angle) ) );         
}

long double lateralController50::get_steering_angles() {
    // return steering angles
    long double steering_angles = 0.0L;
    steering_angles =  m_desired_steering_angle;
    // steering_angles[0] = m_steering_angle_left;
    // steering_angles[1] = m_steering_angle_right;
    return steering_angles;       
}

void lateralController50::estimate_next_state(int the_it_counter, int the_pipe_version) {
    // transfer state vector
    Matrix<long double, 6, 1> zkp_temp, zkp;  
    if (the_it_counter == 0){
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;       
    } else {
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1]; 
    }

    // given the control design, estimate next states
    zkp = m_phi_aug[the_pipe_version]   * zkp_temp + 
          m_Gamma_aug[the_pipe_version] * m_desired_steering_angle;  

        m_z1 = zkp[0];
        m_z2 = zkp[1];
        m_z4 = zkp[3];
        m_z5 = zkp[4];
        m_input[the_it_counter+1] = m_desired_steering_angle;
}

vector<long double> lateralController50::get_steering_angle_left_container(){
    return m_steering_angle_left_container;
}

vector<long double> lateralController50::get_steering_angle_right_container(){
    return m_steering_angle_right_container;
}

