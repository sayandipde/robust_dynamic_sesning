#include <Eigen/Eigen>
#include "config.hpp"

using namespace std;
using namespace Eigen;

// constructor
lateralController30_bev::lateralController30_bev() {
    // initialize member variables 
    // m_d   = 0.135L;   // 2*d = distance between left and right wheels
    // m_l   = 0.42L;    // l = distance between front and read wheels 
    // m_vx  = 2.2L;     // vehicle longitudinal speed is 2.2m/s to simulate ~80km/h in reality
    // m_LL  = 0.55L;    // look-ahead distance is 0.25s*vx
    // m_l_r = 0.21L;    // distance from CG to rear axle (m)
    m_d   = 1.628L;   // 2*d = distance between left and right wheels  
    m_l   = 2.995L;    // l = distance between front and rear wheels 
    m_vx  = 8.333333L;     // vehicle longitudinal speed is 5.55556m/s (20 km/hr)
    m_LL  = 5.5L;    // look-ahead distance is 0.25s*vx
    m_l_r = 1.2975L;    // distance from CG to rear axle (m)
    m_z1    = 0.0L;         // z1 is vy
    m_z2    = 0.0L;         // z2 is yaw rate
    m_z3    = 0.0L;         // z3 is yL
    m_z4    = 0.0L;         // z4 is epsilon_L
    m_z5    = 0.0L;         // z5 is curvature at lookahead distance KL (which is K_ref of CoG)
    fill(m_input.begin(), m_input.end(), 0.0L); // m_input is the input of the last sampling period.

    m_desired_steering_angle = 0.0L;
    m_steering_angle_left    = 0.0L;
    m_steering_angle_right   = 0.0L;

    // controller design time parameters
    // Eigen::Matrix<typename Scalar, int RowsAtCompileTime, int ColsAtCompileTime>
	///// VALUES ARE CONSIDERING ACTUATE DELAY //////////
/////////////////////////////////////////////////////////////// v0 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[0] <<   
0.60806805654952334,   -0.25514844806760095,   0,   0,   0,   1.4862100260130235,
     -0.020679796627017692,   0.69971716698732711,   0,   0,   0,   0.91990185300303984,
     -0.025191951682377599,   -0.16108926163927895,   1,   0.29166666666666669,   0.042534722222222245,   -0.1255882807656688,
     0.000419742819967695,   -0.029404575461172356,   0,   1,   0.29166666666666674,   -0.017206051800215522,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    m_K2c[0] <<
-0.0065416380759259901,   -0.11654103072307942,   0.16138580642819517,   0.6730122225879468,   8.7133595427495267e-15,   -0.14065125827483987; // Q = 7.5, R=200 
// -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
// -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
//-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.5
   

    m_T[0] <<
7.1862275245054841e-17,   -1.2666191880061906e-16,   1.7347234759768071e-15,   -1.3267165144270621e-14,   1,   0,
     -0.00036142507592584191,   0.00047389852483826822,   -0.13652668352236427,   0.99063621449979633,   1.3516965324811281e-14,   0,
     0.40397071812637758,   -0.72883924278757617,   -0.54770247639651115,   -0.074986761621104681,   0,   0,
     -0.34290190167723045,   0.43960332875408276,   -0.8223422164286488,   -0.11366828165185776,   0,   0,
     0.84807182130672887,   0.52492099114185775,   -0.071664085250080403,   -0.0098182406472198201,   0,   0,
      0,   0,   0,   0,   0,   1;
   
    
    m_Gamma_aug[0] <<
0,
     0,
     -0,
     -0,
     0,
     1;
	 
/////////////////////////////////////////////////////////////// v1 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[1] <<   
0.80667814943585048,   -0.13975579835440655,   0,   0,   0,   0.77386732697863558,
     -0.011327215624097747,   0.85687831602401976,   0,   0,   0,   0.44121438263492618,
     -0.012994227742013411,   -0.076205117666897887,   1,   0.125,   0.0078125,   -0.024993648556514318,
     9.0444344489451589e-05,   -0.013896390799172072,   0,   1,   0.125,   -0.0034080327171114649,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[1] <<
-0.017703849014966022,   -0.14134022381804598,   0.27119443852599878,   0.81014942683010494,   -3.2925438691907703e-14,   -0.082507903901206381; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[1] <<
7.101524229780054e-17,   -1.3422422895370545e-16,   -6.0056126738317062e-15,   4.2771342023684156e-14,   0.99999999999999989,   0,
     0.0032185278127687829,   -0.0060224461728811303,   -0.14163880054504269,   0.98989485370971331,   -4.3076653355456074e-14,   0,
     0.36507859432929807,   -0.6768686879676975,   -0.63198241746245465,   -0.095732038679552281,   0,   0,
     -0.33560436231856744,   0.54469320314998215,   -0.76141322281235679,   -0.10454152553631794,   0,   0,
     0.86837605507867965,   0.49509779219180006,   -0.028046003725555949,   -0.003824239508881644,   0,   0,
     0,   0,   0,   0,   0,   1;

    m_Gamma_aug[1] <<
  0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// v2 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[2] <<   
0.80667814943585048,   -0.13975579835440655,   0,   0,   0,   0.77386732697863558,
     -0.011327215624097747,   0.85687831602401976,   0,   0,   0,   0.44121438263492618,
     -0.012994227742013411,   -0.076205117666897887,   1,   0.125,   0.0078125,   -0.024993648556514318,
     9.0444344489451589e-05,   -0.013896390799172072,   0,   1,   0.125,   -0.0034080327171114649,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[2] <<
-0.017703849014966022,   -0.14134022381804598,   0.27119443852599878,   0.81014942683010494,   -3.2925438691907703e-14,   -0.082507903901206381; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[2] <<
7.101524229780054e-17,   -1.3422422895370545e-16,   -6.0056126738317062e-15,   4.2771342023684156e-14,   0.99999999999999989,   0,
     0.0032185278127687829,   -0.0060224461728811303,   -0.14163880054504269,   0.98989485370971331,   -4.3076653355456074e-14,   0,
     0.36507859432929807,   -0.6768686879676975,   -0.63198241746245465,   -0.095732038679552281,   0,   0,
     -0.33560436231856744,   0.54469320314998215,   -0.76141322281235679,   -0.10454152553631794,   0,   0,
     0.86837605507867965,   0.49509779219180006,   -0.028046003725555949,   -0.003824239508881644,   0,   0,
     0,   0,   0,   0,   0,   1;

    m_Gamma_aug[2] <<
  0,
     0,
     -0,
     -0,
     0,
     1;
  
/////////////////////////////////////////////////////////////// v3 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[3] <<   
0.65231268083992666,   -0.23249166193797888,   0,   0,   0,   1.3364669219240388,
     -0.018843462787125859,   0.73582349253483825,   0,   0,   0,   0.81051565775558809,
     -0.022601889987754899,   -0.1414246607435341,   1,   0.25,   0.03125,   -0.094091903436553354,
     0.00032081123590809092,   -0.025816546867549084,   0,   1,   0.25,   -0.012877360998422918,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;


    // q=7.5
    m_K2c[3] <<
-0.012563177680297563,   -0.14249514299786048,   0.2352574775910285,   0.80727465162026502,   8.4339153722735402e-15,   -0.15491827929984697; // Q = 7.5
//-0.29249027996323107,   -0.28549560532646351,   -1.056563344205941,   0.079929179840173781,   -0.18633734617443931; // Q = 2.5
    
    m_T[3] <<
3.8299441743050444e-17,   -6.7112114476852724e-17,   1.4710455076283324e-15,   -1.1074474670635936e-14,   1.0000000000000002,   0,
     0.00062950138253388735,   -0.0012981449146033557,   -0.13779471357228618,   0.99045975963656485,   1.099120794378905e-14,   0,
     0.3943002889173815,   -0.71745295685071009,   -0.56863033865428581,   -0.080299905527684512,   0,   0,
     -0.34075287058509074,   0.46621031365707366,   -0.80874078742470601,   -0.11168600352533035,   0,   0,
     0.8534719486167659,   0.51759782936728671,   -0.060087383277279541,   -0.0082235229350406773,   0,   0,
     0,   0,   0,   0,   0,   1;

  

    m_Gamma_aug[3] <<
0,
     0,
     -0,
     -0,
     0,
     1;
   
/////////////////////////////////////////////////////////////// v4 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[4] <<   
0.80667814943585048,   -0.13975579835440655,   0,   0,   0,   0.77386732697863558,
     -0.011327215624097747,   0.85687831602401976,   0,   0,   0,   0.44121438263492618,
     -0.012994227742013411,   -0.076205117666897887,   1,   0.125,   0.0078125,   -0.024993648556514318,
     9.0444344489451589e-05,   -0.013896390799172072,   0,   1,   0.125,   -0.0034080327171114649,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[4] <<
-0.017703849014966022,   -0.14134022381804598,   0.27119443852599878,   0.81014942683010494,   -3.2925438691907703e-14,   -0.082507903901206381; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[4] <<
7.101524229780054e-17,   -1.3422422895370545e-16,   -6.0056126738317062e-15,   4.2771342023684156e-14,   0.99999999999999989,   0,
     0.0032185278127687829,   -0.0060224461728811303,   -0.14163880054504269,   0.98989485370971331,   -4.3076653355456074e-14,   0,
     0.36507859432929807,   -0.6768686879676975,   -0.63198241746245465,   -0.095732038679552281,   0,   0,
     -0.33560436231856744,   0.54469320314998215,   -0.76141322281235679,   -0.10454152553631794,   0,   0,
     0.86837605507867965,   0.49509779219180006,   -0.028046003725555949,   -0.003824239508881644,   0,   0,
     0,   0,   0,   0,   0,   1;

    m_Gamma_aug[4] <<
  0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// v5 ////////////////////////////////////////////////////////////////////////////
     m_phi_aug[5] <<   
0.80667814943585048,   -0.13975579835440655,   0,   0,   0,   0.77386732697863558,
     -0.011327215624097747,   0.85687831602401976,   0,   0,   0,   0.44121438263492618,
     -0.012994227742013411,   -0.076205117666897887,   1,   0.125,   0.0078125,   -0.024993648556514318,
     9.0444344489451589e-05,   -0.013896390799172072,   0,   1,   0.125,   -0.0034080327171114649,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[5] <<
-0.017703849014966022,   -0.14134022381804598,   0.27119443852599878,   0.81014942683010494,   -3.2925438691907703e-14,   -0.082507903901206381; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[5] <<
7.101524229780054e-17,   -1.3422422895370545e-16,   -6.0056126738317062e-15,   4.2771342023684156e-14,   0.99999999999999989,   0,
     0.0032185278127687829,   -0.0060224461728811303,   -0.14163880054504269,   0.98989485370971331,   -4.3076653355456074e-14,   0,
     0.36507859432929807,   -0.6768686879676975,   -0.63198241746245465,   -0.095732038679552281,   0,   0,
     -0.33560436231856744,   0.54469320314998215,   -0.76141322281235679,   -0.10454152553631794,   0,   0,
     0.86837605507867965,   0.49509779219180006,   -0.028046003725555949,   -0.003824239508881644,   0,   0,
     0,   0,   0,   0,   0,   1;

    m_Gamma_aug[5] <<
  0,
     0,
     -0,
     -0,
     0,
     1;
    
/////////////////////////////////////////////////////////////// v6 ////////////////////////////////////////////////////////////////////////////
     m_phi_aug[6] <<   
0.80667814943585048,   -0.13975579835440655,   0,   0,   0,   0.77386732697863558,
     -0.011327215624097747,   0.85687831602401976,   0,   0,   0,   0.44121438263492618,
     -0.012994227742013411,   -0.076205117666897887,   1,   0.125,   0.0078125,   -0.024993648556514318,
     9.0444344489451589e-05,   -0.013896390799172072,   0,   1,   0.125,   -0.0034080327171114649,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[6] <<
-0.017703849014966022,   -0.14134022381804598,   0.27119443852599878,   0.81014942683010494,   -3.2925438691907703e-14,   -0.082507903901206381; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[6] <<
7.101524229780054e-17,   -1.3422422895370545e-16,   -6.0056126738317062e-15,   4.2771342023684156e-14,   0.99999999999999989,   0,
     0.0032185278127687829,   -0.0060224461728811303,   -0.14163880054504269,   0.98989485370971331,   -4.3076653355456074e-14,   0,
     0.36507859432929807,   -0.6768686879676975,   -0.63198241746245465,   -0.095732038679552281,   0,   0,
     -0.33560436231856744,   0.54469320314998215,   -0.76141322281235679,   -0.10454152553631794,   0,   0,
     0.86837605507867965,   0.49509779219180006,   -0.028046003725555949,   -0.003824239508881644,   0,   0,
     0,   0,   0,   0,   0,   1;

    m_Gamma_aug[6] <<
  0,
     0,
     -0,
     -0,
     0,
     1;
   
/////////////////////////////////////////////////////////////// v7 ////////////////////////////////////////////////////////////////////////////
     m_phi_aug[7] <<   
0.80667814943585048,   -0.13975579835440655,   0,   0,   0,   0.77386732697863558,
     -0.011327215624097747,   0.85687831602401976,   0,   0,   0,   0.44121438263492618,
     -0.012994227742013411,   -0.076205117666897887,   1,   0.125,   0.0078125,   -0.024993648556514318,
     9.0444344489451589e-05,   -0.013896390799172072,   0,   1,   0.125,   -0.0034080327171114649,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[7] <<
-0.017703849014966022,   -0.14134022381804598,   0.27119443852599878,   0.81014942683010494,   -3.2925438691907703e-14,   -0.082507903901206381; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[7] <<
7.101524229780054e-17,   -1.3422422895370545e-16,   -6.0056126738317062e-15,   4.2771342023684156e-14,   0.99999999999999989,   0,
     0.0032185278127687829,   -0.0060224461728811303,   -0.14163880054504269,   0.98989485370971331,   -4.3076653355456074e-14,   0,
     0.36507859432929807,   -0.6768686879676975,   -0.63198241746245465,   -0.095732038679552281,   0,   0,
     -0.33560436231856744,   0.54469320314998215,   -0.76141322281235679,   -0.10454152553631794,   0,   0,
     0.86837605507867965,   0.49509779219180006,   -0.028046003725555949,   -0.003824239508881644,   0,   0,
     0,   0,   0,   0,   0,   1;

    m_Gamma_aug[7] <<
  0,
     0,
     -0,
     -0,
     0,
     1;
	 
/////////////////////////////////////////////////////////////// v8 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[8] <<   
0.65231268083992666,   -0.23249166193797888,   0,   0,   0,   1.3364669219240388,
     -0.018843462787125859,   0.73582349253483825,   0,   0,   0,   0.81051565775558809,
     -0.022601889987754899,   -0.1414246607435341,   1,   0.25,   0.03125,   -0.094091903436553354,
     0.00032081123590809092,   -0.025816546867549084,   0,   1,   0.25,   -0.012877360998422918,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;


    // q=7.5
    m_K2c[8] <<
-0.012563177680297563,   -0.14249514299786048,   0.2352574775910285,   0.80727465162026502,   8.4339153722735402e-15,   -0.15491827929984697; // Q = 7.5
//-0.29249027996323107,   -0.28549560532646351,   -1.056563344205941,   0.079929179840173781,   -0.18633734617443931; // Q = 2.5
    
    m_T[8] <<
3.8299441743050444e-17,   -6.7112114476852724e-17,   1.4710455076283324e-15,   -1.1074474670635936e-14,   1.0000000000000002,   0,
     0.00062950138253388735,   -0.0012981449146033557,   -0.13779471357228618,   0.99045975963656485,   1.099120794378905e-14,   0,
     0.3943002889173815,   -0.71745295685071009,   -0.56863033865428581,   -0.080299905527684512,   0,   0,
     -0.34075287058509074,   0.46621031365707366,   -0.80874078742470601,   -0.11168600352533035,   0,   0,
     0.8534719486167659,   0.51759782936728671,   -0.060087383277279541,   -0.0082235229350406773,   0,   0,
     0,   0,   0,   0,   0,   1;

    m_Gamma_aug[8] <<
0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// no classifier ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[9] <<   
0.69997595086954423,   -0.20598651577423471,   0,   0,   0,   1.1677994417048407,
     -0.016695220134147742,   0.77396614049543766,   0,   0,   0,   0.69392542153826475,
     -0.019723532604260883,   -0.12077000788820828,   1,   0.20833332500000001,   0.021701387152777817,   -0.066653938080711586,
     0.00023182789042342246,   -0.022042946996150305,   0,   1,   0.20833332500000001,   -0.0091118226310436951,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[9] <<
-0.014108343380256266,   -0.14260497357697124,   0.24679648799630038,   0.80956277408932564,   2.648825588227902e-14,   -0.13184951466838979; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[9] <<
4.9114358413593351e-17,   -8.5489341300482025e-17,   4.603956105242446e-15,   -3.3917313402298532e-14,   1,   -3.7413379105773442e-21,
     0.0015509078919193641,   -0.0029646602801059953,   -0.13906639378616562,   0.9902774073932229,   3.4500180490226739e-14,   4.4571290104615003e-08,
     0.38463129025009996,   -0.70504499399884235,   -0.58962486464757546,   -0.08551517945730569,   0,   -8.3324044532735095e-06,
     -0.3388980040290967,   0.49250202096892859,   -0.79410140860517453,   -0.10951185760793813,   0,   9.0006398250288059e-05,
     0.85860530437483262,   0.51023927079002285,   -0.049051095399745434,   -0.0067054852322541852,   0,   -0.0013580688316639227,
     0.0011997540369248494,   0.00064273772474644981,   -4.7350710563969265e-08,   -6.4276358133890815e-09,   0,   0.99999907373880381;
  

    m_Gamma_aug[9] <<
0.001199755148211444,
     0.00064273832009001494,
     -4.7350754423135699e-08,
     -6.4276417670642328e-09,
     0,
     1;

/////////////////////////////////////////////////////////////// 1 classifier ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[10] <<   
0.60806804437991402,   -0.25514843870755982,   0,   0,   0,   1.2271856639351839,
     -0.02067979709786244,   0.69971715690441627,   0,   0,   0,   0.77851014283237951,
     -0.025191951362414085,   -0.16108926049630096,   1,   0.291666655,   0.042534718819444511,   -0.12321633472500487,
     0.00041974283210526709,   -0.02940457526139479,   0,   1,   0.291666655,   -0.016883609016863841,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[10] <<
-0.010944609311610884,   -0.13783167665313367,   0.21742552037153129,   0.78806724534032768,   -1.2090036241017232e-14,   -0.15028403262485615; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[10] <<
-9.8526872424620215e-17,   1.7122262808977329e-16,   -2.0851376181241221e-15,   1.5987211554602254e-14,   0.99999999999999989,   1.4679080975917025e-18,
     -0.0010138677473172986,   0.0015743346390090693,   -0.13583444665419089,   0.99072977912999372,   -1.609823385706477e-14,   3.7280276925520149e-05,
     0.41402222881045414,   -0.73626332904961445,   -0.53049177964133776,   -0.071139482574818322,   0,   -0.0044215494519706583,
     -0.36038496237339357,   0.40685776338734031,   -0.83080584705059224,   -0.11492460253351129,   0,   0.033814486623946781,
     0.7981157514887981,   0.52344109703287922,   -0.099418026268177001,   -0.013635206511707104,   0,   -0.28098185414508481,
     0.24843206766360293,   0.13560977131346533,   -0.0022749493629602951,   -0.00030925704289189198,   0,   0.95910699436828928;
  

    m_Gamma_aug[10] <<
0.25902435194650142,
     0.14139170302139645,
     -0.0023719453369836787,
     -0.00032244269378473511,
     0,
     1;

/////////////////////////////////////////////////////////////// 2 classifier ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[11] <<   
0.56698855358839007,   -0.27433107288035136,   0,   0,   0,   1.3882629588536295,
     -0.022234550811054951,   0.66552805277065086,   0,   0,   0,   0.89700676196163964,
     -0.027517939776382939,   -0.17982892108969201,   1,   0.33333331999999993,   0.055555551111111191,   -0.15902627015954962,
     0.0005271400614430728,   -0.032816913233321261,   0,   1,   0.33333331999999999,   -0.021810563631946292,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[11] <<
-0.0097194531093021397,   -0.13738382823212672,   0.20768419198028137,   0.78488824866854889,   1.9757748575635172e-15,   -0.17368084224509492; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[11] <<
2.4448758989548125e-17,   -4.0494951142333591e-17,   2.8102520310824275e-16,   -2.2204460492503131e-15,   0.99999999999999989,   -3.3203691532368573e-19,
     -0.0020492896045307858,   0.0033787341968768256,   -0.13466056998169201,   0.99088390496501411,   2.6367796834847468e-15,   4.8382165657245685e-05,
     0.42272162658649454,   -0.74478171361568968,   -0.51205797989564605,   -0.06617433442903059,   0,   -0.0049201796522183377,
     -0.36156796905283495,   0.38327500773537243,   -0.84123980560161715,   -0.11638034144786508,   0,   0.033765038076246895,
     0.80027789108168956,   0.53246147526414556,   -0.1094323540822174,   -0.01501996682666271,   0,   -0.25266387727952622,
     0.22388865006747616,   0.12195830854797853,   -0.0018180948197042393,   -0.00024711366540741599,   0,   0.96695226191014305;
  

    m_Gamma_aug[11] <<
0.2315405412312711,
     0.12612650422582275,
     -0.0018802322423991508,
     -0.00025555932297966925,
     0,
     1;
}
// destructor
lateralController30_bev::~lateralController30_bev(){}

// class methods
void lateralController30_bev::compute_steering_angles(long double the_yL, int the_it_counter, int the_pipe_version) {
    m_z3 = the_yL;
    m_z5 = 2 * m_z3 / ( pow( m_LL + m_l_r, 2 ) );   // curvature calculate

    Matrix<long double, 6, 1> zt_temp, zt;       // zt is the transferred state vector
    if (the_it_counter == 0){
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;
    } else {
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1];
    }

    // zt = m_T[the_pipe_version] * zt_temp;        

    // Matrix<long double, 6, 1> zt_temp_2;
    // zt_temp_2 << zt[1], 
    //              zt[2], 
    //              zt[3], 
    //              zt[4], 
    //              zt[5],
    //              zt[6];

    // calculate the desired steering angle 
    m_desired_steering_angle = m_K2c[the_pipe_version] * zt_temp;   
    // calculate left front tire steering angle according to desired steering angle                     
    m_steering_angle_left    = atan( m_l / (-m_d + m_l / tan(m_desired_steering_angle) ) );  
    // calculate right front tire steering angle according to desired steering angle 
    m_steering_angle_right   = atan( m_l / ( m_d + m_l / tan(m_desired_steering_angle) ) );         
}

long double lateralController30_bev::get_steering_angles() {
    // return steering angles
    long double steering_angles = 0.0L;
    steering_angles =  m_desired_steering_angle;
    // steering_angles[0] = m_steering_angle_left;
    // steering_angles[1] = m_steering_angle_right;
    return steering_angles;       
}

void lateralController30_bev::estimate_next_state(int the_it_counter, int the_pipe_version) {
    // transfer state vector
    Matrix<long double, 6, 1> zkp_temp, zkp;  
    if (the_it_counter == 0){
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;       
    } else {
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1]; 
    }

    // given the control design, estimate next states
    zkp = m_phi_aug[the_pipe_version]   * zkp_temp + 
          m_Gamma_aug[the_pipe_version] * m_desired_steering_angle;  

        m_z1 = zkp[0];
        m_z2 = zkp[1];
        m_z4 = zkp[3];
        m_z5 = zkp[4];
        m_input[the_it_counter+1] = m_desired_steering_angle;
}

vector<long double> lateralController30_bev::get_steering_angle_left_container(){
    return m_steering_angle_left_container;
}

vector<long double> lateralController30_bev::get_steering_angle_right_container(){
    return m_steering_angle_right_container;
}

