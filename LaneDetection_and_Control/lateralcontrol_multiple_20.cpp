#include <Eigen/Eigen>
#include "config.hpp"

using namespace std;
using namespace Eigen;

// constructor
lateralController::lateralController() {
    // initialize member variables 
    // m_d   = 0.135L;   // 2*d = distance between left and right wheels
    // m_l   = 0.42L;    // l = distance between front and read wheels 
    // m_vx  = 2.2L;     // vehicle longitudinal speed is 2.2m/s to simulate ~80km/h in reality
    // m_LL  = 0.55L;    // look-ahead distance is 0.25s*vx
    // m_l_r = 0.21L;    // distance from CG to rear axle (m)
    m_d   = 1.628L;   // 2*d = distance between left and right wheels  
    m_l   = 2.995L;    // l = distance between front and rear wheels 
    m_vx  = 5.55556L;     // vehicle longitudinal speed is 5.55556m/s (20 km/hr)
    m_LL  = 5.5L;    // look-ahead distance is 0.25s*vx
    m_l_r = 1.2975L;    // distance from CG to rear axle (m)
    m_z1    = 0.0L;         // z1 is vy
    m_z2    = 0.0L;         // z2 is yaw rate
    m_z3    = 0.0L;         // z3 is yL
    m_z4    = 0.0L;         // z4 is epsilon_L
    m_z5    = 0.0L;         // z5 is curvature at lookahead distance KL (which is K_ref of CoG)
    fill(m_input.begin(), m_input.end(), 0.0L); // m_input is the input of the last sampling period.

    m_desired_steering_angle = 0.0L;
    m_steering_angle_left    = 0.0L;
    m_steering_angle_right   = 0.0L;

    // controller design time parameters
    // Eigen::Matrix<typename Scalar, int RowsAtCompileTime, int ColsAtCompileTime>
	///// VALUES ARE CONSIDERING ACTUATE DELAY //////////
/////////////////////////////////////////////////////////////// v0 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[0] <<   
0.42641040396470165,   -0.18900882286115009,   0,   0,   0,   1.3317604038465074,
     -0.026091525613902437,   0.54204331639649972,   0,   0,   0,   0.8530273808054526,
     -0.023084875203527009,   -0.1630068262528459,   1,   0.22222239999999999,   0.024691397530879997,   -0.14842819366744009,
     0.00067693445806776798,   -0.029864641785465964,   0,   1,   0.22222239999999999,   -0.020464735286108763,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    m_K2c[0] <<
-0.00078748201422394054,   -0.053474775749767764,   0.084161081065680085,   0.42491045569533431,   1.5672622046407659e-15,   -0.06603273291754401; // Q = 7.5, R=200 
// -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
// -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
//-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.5
   

    m_T[0] <<
2.6115719829744588e-17,   -4.5929514531917182e-17,   5.4470317145671743e-16,   -4.0523140398818214e-15,   1,   -3.1340219048409113e-19,
     -0.00055723382666925505,   0.00058714095011454508,   -0.13813811925925687,   0.9904126432981184,   3.8302694349567901e-15,   2.7544813194331635e-05,
     0.4442859279080501,   -0.7721258928414757,   -0.45007437831798497,   -0.062066466520193278,   0,   -0.0035252775797043898,
     -0.32240769589454144,   0.33521606600699982,   -0.87656127219262936,   -0.12263925107216186,   0,   0.01683499056317795,
     0.82700737050895201,   0.53586239400216218,   -0.099954939292622155,   -0.013789815849640948,   0,   -0.13685450269531341,
     0.12133338578143626,   0.065596834179105307,   -0.0005100904256527376,   -6.9312511431725274e-05,   0,   0.9904418205245703;
   
    
    m_Gamma_aug[0] <<
0.12250430390466958,
     0.066229871174425053,
     -0.00051501301245799279,
     -6.9981406272823875e-05,
     0,
     1;
	 
/////////////////////////////////////////////////////////////// v1 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[1] <<   
0.58533030092975247,   -0.15552591280556688,   0,   0,   0,   0.83825137175339837,
     -0.021469412253696904,   0.68047884470716613,   0,   0,   0,   0.51166757603241209,
     -0.017594309890264948,   -0.11330462071723786,   1,   0.13888900000000001,   0.0096450771605000006,   -0.061146365570038282,
     0.00031483441512179523,   -0.02073691861787243,   0,   1,   0.13888900000000001,   -0.0083916659594225739,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[1] <<
-0.0019314827894710007,   -0.063563776279928444,   0.11502818668785604,   0.46115732694290501,   -6.2738914422635476e-15,   -0.044045915511737248; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[1] <<
-1.3877787807814457e-17,   2.0274580625478933e-17,   -1.9463597400459776e-15,   1.4099832412739488e-14,   1,   5.5861822871421107e-19,
     0.001882807924134368,   -0.0036572327300394801,   -0.14061331015445139,   0.99005604712973649,   -1.4238610290817633e-14,   1.5242313791145444e-05,
     0.41236911992999709,   -0.73793911387607303,   -0.52840683466842608,   -0.078557377970537065,   0,   -0.0035395737094252289,
     -0.33573429652370645,   0.42173471576772881,   -0.83385792309137052,   -0.11623320630138514,   0,   0.024354003873905045,
     0.81232550922037072,   0.51036056399716312,   -0.07543530422189576,   -0.010369120954567306,   0,   -0.27177446162938645,
     0.23949512139097506,   0.13078384110189151,   -0.0021431420388119049,   -0.00029153347029738612,   0,   0.96204625444257841;
   

    m_Gamma_aug[1] <<
0.24894345805622578,
     0.13594340240705921,
     -0.0022276912663140801,
     -0.0003030347750444746,
     0,
     1;

/////////////////////////////////////////////////////////////// v2 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[2] <<   
0.47370676351804597,   -0.18122676854239622,   0,   0,   0,   1.0843019312648767,
     -0.025017260050459893,   0.58457872568330005,   0,   0,   0,   0.69162710374886482,
     -0.021557422401897008,   -0.14765932356952322,   1,   0.19444460000000002,   0.018904351234580005,   -0.1147253995803378,
     0.0005489934094110771,   -0.027049487309100704,   0,   1,   0.19444460000000002,   -0.015797309248662846,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
  

     // q=10
    m_K2c[2] <<
-0.0013092283394669293,   -0.059415865973543203,   0.10055657423158876,   0.44894488209222583,   9.9215481938867705e-16,   -0.059501717923041833; // Q = 10
//-0.55384827844383655,   -0.4049400023031392,   -1.3381579348303918,   0.07798629268032041,   -0.15594781780844005; // Q = 5
    

    m_T[2] <<
1.1255373803115143e-17,   -2.0206817989698589e-17,   2.6020852139652106e-16,   -1.9706458687096529e-15,   0.99999999999999978,   -2.6681537838510461e-19,
     9.330322327059896e-05,   -0.0005600930071723891,   -0.1387751230433853,   0.99032375548849583,   2.3037127760971998e-15,   4.6149615667603109e-05,
     0.43973244936637235,   -0.76523291138476113,   -0.46549967759655492,   -0.065704865437175616,   0,   -0.0068472712257794371,
     -0.33322913677283572,   0.34644988672677207,   -0.8677074346954039,   -0.12136710235903998,   0,   0.035842051167995499,
     0.79454431525716518,   0.52456476859670043,   -0.10549608814587561,   -0.01454810154237028,   0,   -0.28668809317277838,
     0.25356071810695124,   0.13864543686513051,   -0.0024286914245436088,   -0.0003304232554864362,   0,   0.95732878226239526;
 


    m_Gamma_aug[2] <<
0.26486273347775774,
     0.14482530916648972,
     -0.0025369459996847001,
     -0.0003451512809481896,
     0,
     1;
  
/////////////////////////////////////////////////////////////// v3 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[3] <<   
0.42641040396470165,   -0.18900882286115009,   0,   0,   0,   1.2980145627066337,
     -0.026091525613902437,   0.54204331639649972,   0,   0,   0,   0.83456154306514008,
     -0.023084875203527009,   -0.1630068262528459,   1,   0.22222239999999999,   0.024691397530879997,   -0.14809515211971166,
     0.00067693445806776798,   -0.029864641785465964,   0,   1,   0.22222239999999999,   -0.020419447613086311,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;


    // q=7.5
    m_K2c[3] <<
-0.001105635235172632,   -0.058289906502488789,   0.096153748100712727,   0.44657266031503501,   -9.2751079894393531e-15,   -0.07132270159066488; // Q = 7.5
//-0.29249027996323107,   -0.28549560532646351,   -1.056563344205941,   0.079929179840173781,   -0.18633734617443931; // Q = 2.5
    
    m_T[3] <<
-1.5650458359828257e-16,   2.6533137666151507e-16,   -2.886579864025407e-15,   2.1788126858268697e-14,   0.99999999999999967,   2.2895300564283738e-18,
     -0.00064708838632330796,   0.00072790914389957682,   -0.13807513000547297,   0.99042127832790383,   -2.1621593404574924e-14,   3.6526578469395353e-05,
     0.44613470749703255,   -0.77297537909722946,   -0.44685240774225699,   -0.061436170832136011,   0,   -0.0046269519625018497,
     -0.324609569518646,   0.3296745726687102,   -0.87770924428702024,   -0.12281707787327335,   0,   0.022039768338172158,
     0.81971062369231806,   0.53560199927434315,   -0.10432626461235014,   -0.014395862300474517,   0,   -0.17353322863341397,
     0.15383928245421274,   0.08338889594425454,   -0.00083496949704532305,   -0.00011349053431526475,   0,   0.9845704937448656;

  

    m_Gamma_aug[3] <<
0.15625014504454326,
     0.08469570891473753,
     -0.00084805456018641472,
     -0.00011526907929527478,
     0,
     1;
   
/////////////////////////////////////////////////////////////// v4 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[4] <<   
0.65103106925345744,   -0.13641722091881014,   0,   0,   0,   0.71958877970422763,
     -0.018831572832953326,   0.73448918682653064,   0,   0,   0,   0.42801257961808892,
     -0.01506936298216187,   -0.094063019054355212,   1,   0.11111119999999999,   0.0061728493827199991,   -0.040283218699647544,
     0.00021380994598762536,   -0.017201303215627035,   0,   1,   0.11111119999999999,   -0.0055178147711599582,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    // q=7.5
    m_K2c[4] <<
-0.0017640306655348909,   -0.060142002550245072,   0.10717314840759407,   0.44444197448830103,   -3.0675841921803667e-15,   -0.033187073072384332; // Q = 7.5
//-0.46487306713255255,   -0.39591077537968483,   -0.99753184127862682,   0.031201430643079647,   -0.083594546113972892; // Q = 2.5

    m_T[4] <<
5.6378512969246231e-18,   -1.1817803680091998e-17,   -9.7491459349896559e-16,   6.9388939039072284e-15,   1,   1.0217334926254998e-19,
     0.0026882069881977648,   -0.0050876887559700469,   -0.14159684739376802,   0.9899076834419912,   -7.2164496600635175e-15,   6.080122612814771e-06,
     0.39612860264561189,   -0.71887387254925073,   -0.56478220163762682,   -0.085557119523431827,   0,   -0.0018787081430249348,
     -0.33582041195409179,   0.46544229174077023,   -0.81095001983575776,   -0.1126946315774551,   0,   0.015751486154940032,
     0.83074068292448888,   0.5046407864700162,   -0.057700372750550281,   -0.0079144294351845609,   0,   -0.22763045305108068,
     0.20042323308030241,   0.10906704579839466,   -0.0014593951940701465,   -0.00019844823327205211,   0,   0.9736183738747004;

    m_Gamma_aug[4] <<
0.20585399624565404,
     0.11202237830038222,
     -0.0014989396597582729,
     -0.00020382548090407273,
     0,
     1;

/////////////////////////////////////////////////////////////// v5 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[5] <<   
0.52646415452459405,   -0.17025076499694416,   0,   0,   0,   1.2215795945301835,
     -0.023502089100716304,   0.63062115366531923,   0,   0,   0,   0.74293631317308251,
     -0.019741179568021155,   -0.13112910342528949,   1,   0.16666679999999995,   0.013888911111119995,   -0.088640890193333224,
     0.00042749615948111519,   -0.024013010966289175,   0,   1,   0.16666679999999998,   -0.012182528283260781,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    // q=10
    m_K2c[5] <<
-0.0017238093690791281,   -0.063800120103253533,   0.11314267680682769,   0.46487040546332847,   -7.3919055487993741e-15,   -0.063555043242371378; // Q = 10
//-0.63522128039691028,   -0.43222747563713443,   -1.3136448099423239,   -0.046596736146638111,   -0.2393966050959451; // Q = 5        

    m_T[5] <<
-2.802662615875029e-17,   4.7379634937616544e-17,   -2.3141211169530607e-15,   1.6875389974302379e-14,   0.99999999999999967,   1.9772925362467574e-20,
     0.0015598075006419156,   -0.0030536164190519068,   -0.14017536382917231,   0.99012075516195475,   -1.6625589793761719e-14,   4.5259421713843039e-07,
     0.41272540973167926,   -0.74217345870722828,   -0.52241998662829847,   -0.076900212937135962,   0,   -9.0409508220805929e-05,
     -0.32045366726759422,   0.42434038617755093,   -0.83879080170688414,   -0.11693744086239662,   0,   0.00055649790063327931,
     0.85260122484936929,   0.51874286320521668,   -0.062114538694017132,   -0.0085371173278986669,   0,   -0.0067745826120490047,
     0.0059918012719817337,   0.0032110978895891311,   -1.1830724251580102e-06,   -1.6060333403983293e-07,   0,   0.99997689331625794;
  
 
    m_Gamma_aug[5] <<
0.0059919397258377917,
     0.003211172089127036,
     -1.1830997626700614e-06,
     -1.6060704513603165e-07,
     0,
     1;
    
/////////////////////////////////////////////////////////////// v6 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[6] <<   
0.65103106925345744,   -0.13641722091881014,   0,   0,   0,   0.91347499003209853,
     -0.018831572832953326,   0.73448918682653064,   0,   0,   0,   0.53361842100571555,
     -0.01506936298216187,   -0.094063019054355212,   1,   0.11111119999999999,   0.0061728493827199991,   -0.041777429045414011,
     0.00021380994598762536,   -0.017201303215627035,   0,   1,   0.11111119999999999,   -0.005720998211221697,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    // q=7.5  
    m_K2c[6] <<
-0.0018526489767184094,   -0.061726593006548536,   0.11106719096767328,   0.4507773933336453,   -1.0294477957105571e-14,   -0.041104458900093357; // Q = 7.5
//-0.46554971227596326,   -0.4654602657211161,   -0.96898250924162621,   -0.024911592813389019,   -0.12797956522986562; // Q = 2.5    

    m_T[6] <<
2.9110828331235794e-17,   -5.6378512969246231e-17,   -3.282096816548119e-15,   2.3342439092743916e-14,   1,   1.4545143891132439e-20,
     0.0029938871680704185,   -0.0056280167185760489,   -0.14197220463926019,   0.9898501175315626,   -2.3897550605056495e-14,   2.4626940028067293e-07,
     0.38586144577591514,   -0.70727650788464458,   -0.5855920357773361,   -0.08917873564587353,   0,   -8.2468061604651282e-05,
     -0.3271861884676418,   0.49537911589585787,   -0.79707850763722876,   -0.1105171689787626,   0,   0.00073323528480723687,
     0.86250100167241806,   0.50426841463778471,   -0.039896282840250485,   -0.0054638166022682559,   0,   -0.013558076428391318,
     0.011966682641288973,   0.0064159453902803507,   -4.7288780096596327e-06,   -6.4198165439644255e-07,   0,   0.99990781281502994;
  
    m_Gamma_aug[6] <<
0.011967785917783171,
     0.0064165369127555947,
     -4.7293139918033771e-06,
     -6.420408423343332e-07,
     0,
     1;
   
/////////////////////////////////////////////////////////////// v7 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[7] <<   
0.65103106925345744,   -0.13641722091881014,   0,   0,   0,   0.69792735325099287,
     -0.018831572832953326,   0.73448918682653064,   0,   0,   0,   0.41600897662720393,
     -0.01506936298216187,   -0.094063019054355212,   1,   0.11111119999999999,   0.0061728493827199991,   -0.039936363425207316,
     0.00021380994598762536,   -0.017201303215627035,   0,   1,   0.11111119999999999,   -0.0054706022154403528,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[7] <<
-0.001753616686466293,   -0.059956651672922343,   0.10671776538445625,   0.44369513672049077,   -1.5702408552085911e-14,   -0.03227933955895633; // Q = 7.5
//-0.46477141465361482,   -0.38867121192261134,   -1.0000986318914686,   0.029183424068099584,   -0.079108432008016372; // Q = 2.5
    

    m_T[7] <<
2.8731357570865868e-17,   -6.2016364266170854e-17,   -5.1764148523147924e-15,   3.6914915568786455e-14,   0.99999999999999978,   6.3845108399292888e-19,
     0.0026510559379724174,   -0.0050225306497447258,   -0.14155281500280756,   0.9899144137773277,   -3.6998182295633342e-14,   6.9968820802817673e-06,
     0.39734082702032725,   -0.72016046397585398,   -0.56234977390154228,   -0.085131177114200499,   0,   -0.0021419115107495974,
     -0.33690975690573116,   0.46184655942692077,   -0.81247583021469871,   -0.1129345719867349,   0,   0.017843178370080422,
     0.82468111022558577,   0.50361385514531321,   -0.060044692478055516,   -0.0082376862398923899,   0,   -0.25020177212282019,
     0.22024105254023962,   0.1200604879348172,   -0.0017867791741720254,   -0.00024301157590888976,   0,   0.96802691407748442;
  

    m_Gamma_aug[7] <<
0.22751542269888878,
     0.1240259812912672,
     -0.0018457949341984981,
     -0.00025103803662367824,
     0,
     1;
	 
/////////////////////////////////////////////////////////////// v8 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[8] <<   
0.42641040396470165,   -0.18900882286115009,   0,   0,   0,   1.2213704878091132,
     -0.026091525613902437,   0.54204331639649972,   0,   0,   0,   0.79224386176767203,
     -0.023084875203527009,   -0.1630068262528459,   1,   0.22222239999999999,   0.024691397530879997,   -0.14700521212983408,
     0.00067693445806776798,   -0.029864641785465964,   0,   1,   0.22222239999999999,   -0.020271126642339755,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[8] <<
-0.00074742811269116333,   -0.052611647574176863,   0.082209372775624678,   0.42082695491536137,   -3.7695182287620975e-15,   -0.061530510602043322; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[8] <<
-7.0120775505499999e-17,   1.1405806854547507e-16,   -1.1969591984239969e-15,   8.992806499463768e-15,   1,   1.5382118322138094e-18,
     -0.00086056634820388109,   0.0010599958279744518,   -0.13792836000272141,   0.99044126519181708,   -9.298117831235686e-15,   5.955331732237638e-05,
     0.45046784411549745,   -0.77482836390148113,   -0.4393964003985113,   -0.059969042149734142,   0,   -0.0073651349046695179,
     -0.32985532808130125,   0.31653727906401491,   -0.88011747397029361,   -0.12319218899758168,   0,   0.034878791281527481,
     0.79849854262488251,   0.53326571121246624,   -0.11530955707983441,   -0.015919605753738825,   0,   -0.25392524661738342,
     0.22510779818969362,   0.12276691374474916,   -0.0018732010016266386,   -0.00025477736546827601,   0,   0.96656670245269627;
  

    m_Gamma_aug[8] <<
0.23289421994206388,
     0.12701339021220562,
     -0.0019379945500639807,
     -0.00026359005004183332,
     0,
     1;
}
// destructor
lateralController::~lateralController(){}

// class methods
void lateralController::compute_steering_angles(long double the_yL, int the_it_counter, int the_pipe_version) {
    m_z3 = the_yL;
    m_z5 = 2 * m_z3 / ( pow( m_LL + m_l_r, 2 ) );   // curvature calculate

    Matrix<long double, 6, 1> zt_temp, zt;       // zt is the transferred state vector
    if (the_it_counter == 0){
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;
    } else {
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1];
    }

    // zt = m_T[the_pipe_version] * zt_temp;        

    // Matrix<long double, 6, 1> zt_temp_2;
    // zt_temp_2 << zt[1], 
    //              zt[2], 
    //              zt[3], 
    //              zt[4], 
    //              zt[5],
    //              zt[6];

    // calculate the desired steering angle 
    m_desired_steering_angle = m_K2c[the_pipe_version] * zt_temp;   
    // calculate left front tire steering angle according to desired steering angle                     
    m_steering_angle_left    = atan( m_l / (-m_d + m_l / tan(m_desired_steering_angle) ) );  
    // calculate right front tire steering angle according to desired steering angle 
    m_steering_angle_right   = atan( m_l / ( m_d + m_l / tan(m_desired_steering_angle) ) );         
}

long double lateralController::get_steering_angles() {
    // return steering angles
    long double steering_angles = 0.0L;
    steering_angles =  m_desired_steering_angle;
    // steering_angles[0] = m_steering_angle_left;
    // steering_angles[1] = m_steering_angle_right;
    return steering_angles;       
}

void lateralController::estimate_next_state(int the_it_counter, int the_pipe_version) {
    // transfer state vector
    Matrix<long double, 6, 1> zkp_temp, zkp;  
    if (the_it_counter == 0){
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;       
    } else {
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1]; 
    }

    // given the control design, estimate next states
    zkp = m_phi_aug[the_pipe_version]   * zkp_temp + 
          m_Gamma_aug[the_pipe_version] * m_desired_steering_angle;  

        m_z1 = zkp[0];
        m_z2 = zkp[1];
        m_z4 = zkp[3];
        m_z5 = zkp[4];
        m_input[the_it_counter+1] = m_desired_steering_angle;
}

vector<long double> lateralController::get_steering_angle_left_container(){
    return m_steering_angle_left_container;
}

vector<long double> lateralController::get_steering_angle_right_container(){
    return m_steering_angle_right_container;
}

