#include <Eigen/Eigen>
#include "config.hpp"

using namespace std;
using namespace Eigen;

// constructor
lateralController::lateralController() {
    // initialize member variables 
    // m_d   = 0.135L;   // 2*d = distance between left and right wheels
    // m_l   = 0.42L;    // l = distance between front and read wheels 
    // m_vx  = 2.2L;     // vehicle longitudinal speed is 2.2m/s to simulate ~80km/h in reality
    // m_LL  = 0.55L;    // look-ahead distance is 0.25s*vx
    // m_l_r = 0.21L;    // distance from CG to rear axle (m)
    m_d   = 1.628L;   // 2*d = distance between left and right wheels  
    m_l   = 2.995L;    // l = distance between front and rear wheels 
    m_vx  = 5.55556L;     // vehicle longitudinal speed is 5.55556m/s (20 km/hr)
    m_LL  = 5.5L;    // look-ahead distance is 0.25s*vx
    m_l_r = 1.2975L;    // distance from CG to rear axle (m)
    m_z1    = 0.0L;         // z1 is vy
    m_z2    = 0.0L;         // z2 is yaw rate
    m_z3    = 0.0L;         // z3 is yL
    m_z4    = 0.0L;         // z4 is epsilon_L
    m_z5    = 0.0L;         // z5 is curvature at lookahead distance KL (which is K_ref of CoG)
    fill(m_input.begin(), m_input.end(), 0.0L); // m_input is the input of the last sampling period.

    m_desired_steering_angle = 0.0L;
    m_steering_angle_left    = 0.0L;
    m_steering_angle_right   = 0.0L;

    // controller design time parameters
    // Eigen::Matrix<typename Scalar, int RowsAtCompileTime, int ColsAtCompileTime>
	///// VALUES ARE CONSIDERING ACTUATE DELAY //////////
/////////////////////////////////////////////////////////////// v0 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[0] <<   
0.65410859174809333,   -0.36719940738768858,   0,   0,   0,   1.5617305878025045,
     -0.018860104172713662,   0.73769315504767896,   0,   0,   0,   1.014694013894841,
     -0.030131838886051653,   -0.18918275513743205,   1,   0.44444440000000002,   0.098765412345680009,   -0.16696024677538004,
     0.00042792782738746815,   -0.034449318055785751,   0,   1,   0.44444440000000002,   -0.022831802971614919,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    m_K2c[0] <<
-0.0050002562222362795,   -0.11710126536035613,   0.10527858157268412,   0.66160480251248788,   -1.2994826969057305e-14,   -0.14909131342852858; // Q = 7.5, R=200 
// -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
// -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
//-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.5
   

    m_T[0] <<
-1.7780915628762273e-16,   3.1420178958629918e-16,   -2.4875934645507414e-15,   2.0039525594484076e-14,   0.99999999999999989,   1.0134749213897704e-18,
     -0.0028548228479799453,   0.0049889149386908409,   -0.13190342568174188,   0.99124590620699582,   -2.0261570199409107e-14,   2.086945958335843e-05,
     0.39308014589368301,   -0.70273360391617501,   -0.5884117353704017,   -0.073629994801833937,   0,   -0.0019324531195603098,
     -0.39083150054473298,   0.4558953831393634,   -0.79200162466230095,   -0.10881080918774838,   0,   0.017429060512502002,
     0.82324752492213815,   0.54214068042065466,   -0.095426824516524095,   -0.013052977968682896,   0,   -0.13809538830621851,
     0.12245039723183404,   0.066207816154601168,   -0.00051348493804495555,   -6.973815588730792e-05,   0,   0.99026368042436697;
   
    
    m_Gamma_aug[0] <<
0.12365433535779,
     0.066858774550055705,
     -0.00051853354636303235,
     -7.0423824750820291e-05,
     0,
     1;
	 
/////////////////////////////////////////////////////////////// v1 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[1] <<   
0.76559386656735651,   -0.26332941651223368,   0,   0,   0,   0.94750765293462225,
     -0.01352513137886709,   0.82553479740843305,   0,   0,   0,   0.58124174956729369,
     -0.020905745539356962,   -0.1247651576664304,   1,   0.27777774999999999,   0.038580239197531244,   -0.066136753997808745,
     0.00018283726960592009,   -0.022739242686482537,   0,   1,   0.27777774999999999,   -0.0090254743925330186,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[1] <<
-0.0085070076936130251,   -0.12456004099200929,   0.1327275425213876,   0.71470876465500133,   2.2444978652931891e-14,   -0.091056716372415122; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[1] <<
1.066162488291356e-16,   -1.9097543641974357e-16,   4.2292558344314557e-15,   -3.2085445411667024e-14,   1.0000000000000002,   -9.4211239558359555e-19,
     1.3048470166827962e-05,   -0.00014057468483589332,   -0.13619873498421345,   0.99068152526335107,   3.2529534621517087e-14,   1.2612509263198895e-05,
     0.37220367933992621,   -0.67840297112330084,   -0.62751125819778242,   -0.086371287759053159,   0,   -0.0018577789907671463,
     -0.38295342502815594,   0.50914292023616181,   -0.76322267143328315,   -0.1048507553626956,   0,   0.024852242206952872,
     0.80954434044172929,   0.51264430211472534,   -0.071874668122538746,   -0.0098157147932738664,   0,   -0.27671549322985733,
     0.24382177104091496,   0.13318669337638672,   -0.0021705566691409888,   -0.00029495032138287071,   0,   0.96062867454703305;
   

    m_Gamma_aug[1] <<
0.2538147959781491,
     0.1386453443513837,
     -0.0022595168420976768,
     -0.00030703884778574735,
     0,
     1;

/////////////////////////////////////////////////////////////// v2 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[2] <<   
0.68916819371627913,   -0.33633721925375204,   0,   0,   0,   1.2701260271892763,
     -0.01727495977570925,   0.76572768435576322,   0,   0,   0,   0.81829111795984821,
     -0.027292977355272974,   -0.16846365998327106,   1,   0.38888885000000006,   0.075617268827161271,   -0.12753661801973007,
     0.00033751469749892946,   -0.030691264103910501,   0,   1,   0.38888885000000006,   -0.017430771528250413,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
  

     // q=10
    m_K2c[2] <<
-0.0054980484147848646,   -0.11607128246548418,   0.10772192990411406,   0.65857034310781382,   -4.0726792197482412e-16,   -0.11978220613485906; // Q = 10
//-0.55384827844383655,   -0.4049400023031392,   -1.3381579348303918,   0.07798629268032041,   -0.15594781780844005; // Q = 5
    

    m_T[2] <<
-3.9573379295720912e-18,   6.8304736866586779e-18,   -9.0205620750793969e-17,   6.9388939039072284e-16,   0.99999999999999989,   5.6751207466038123e-20,
     -0.0021354801516440584,   0.0036930635760831208,   -0.13296238205423938,   0.99111190321390952,   -6.3837823915946501e-16,   3.5666643642250243e-05,
     0.38953126480108985,   -0.69762697210014468,   -0.59641001372195301,   -0.076572328953473129,   0,   -0.003711537642019566,
     -0.39656598033659923,   0.46157271204113004,   -0.78528738942478205,   -0.10792572856138818,   0,   0.036902680980825248,
     0.79007947930390021,   0.52941191407487975,   -0.099668239966026542,   -0.013630809754851788,   0,   -0.29219494277956182,
     0.25840021882640696,   0.14133869185178996,   -0.0024613904866104984,   -0.00033449404143058538,   0,   0.9556393309019352;
 


    m_Gamma_aug[2] <<
0.27039512760795231,
     0.14789961785938016,
     -0.0025756479531743749,
     -0.00035002121680664702,
     0,
     1;
  
/////////////////////////////////////////////////////////////// v3 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[3] <<   
0.65410859174809333,   -0.36719940738768858,   0,   0,   0,   1.5272513549365294,
     -0.018860104172713662,   0.73769315504767896,   0,   0,   0,   0.99582331360214882,
     -0.030131838886051653,   -0.18918275513743205,   1,   0.44444440000000002,   0.098765412345680009,   -0.16662327720189271,
     0.00042792782738746815,   -0.034449318055785751,   0,   1,   0.44444440000000002,   -0.022786021387804958,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;


    // q=7.5
    m_K2c[3] <<
-0.0033704223387724247,   -0.10511257334337731,   0.086510204860721973,   0.59335177211435564,   -1.3754503896654597e-15,   -0.12978073954649033; // Q = 7.5
//-0.29249027996323107,   -0.28549560532646351,   -1.056563344205941,   0.079929179840173781,   -0.18633734617443931; // Q = 2.5
    
    m_T[3] <<
-2.1629833341085813e-17,   3.7404974950749903e-17,   -2.9837243786801082e-16,   2.3869795029440866e-15,   1,   1.5924219408380846e-19,
     -0.0029481283934695694,   0.0051447010768162355,   -0.13178840671385514,   0.99126013522406142,   -2.3869795029440866e-15,   2.7589936802677965e-05,
     0.3942284119274041,   -0.70350162896780311,   -0.58677630127522251,   -0.073188358546708771,   0,   -0.0025404141103433924,
     -0.39362668459550371,   0.4518926327730633,   -0.79275989180014017,   -0.10891440417392377,   0,   0.02281420908667376,
     0.81572717880853318,   0.54197126110989424,   -0.099279570527241845,   -0.013581162387437064,   0,   -0.17554327326375929,
     0.15563569865424753,   0.084375296543821504,   -0.0008419896373323513,   -0.00011436983400745919,   0,   0.98420405232377384;

  

    m_Gamma_aug[3] <<
0.15813356822376509,
     0.085729474842747899,
     -0.00085550311985035574,
     -0.00011620540856077975,
     0,
     1;
   
/////////////////////////////////////////////////////////////// v4 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[4] <<   
0.80722327763050883,   -0.22058551878751234,   0,   0,   0,   0.79524671085403409,
     -0.0113297183481894,   0.85743453583823359,   0,   0,   0,   0.47456491695949121,
     -0.017325353098857531,   -0.1016919646208735,   1,   0.22222220000000001,   0.024691353086420002,   -0.042930571769479751,
     0.00012060545680407168,   -0.01853239701015548,   0,   1,   0.22222220000000001,   -0.0058533301781459046,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    // q=7.5
    m_K2c[4] <<
-0.0073243643533211431,   -0.11645444145321274,   0.11983762611092877,   0.66443919021978526,   1.8062440277434157e-14,   -0.067511734950363292; // Q = 7.5
//-0.46487306713255255,   -0.39591077537968483,   -0.99753184127862682,   0.031201430643079647,   -0.083594546113972892; // Q = 2.5

    m_T[4] <<
3.9627589404345187e-17,   -6.727474480272555e-17,   3.7712888367735786e-15,   -2.8005375796169574e-14,   1,   -3.3351922298138076e-19,
     0.0011010015542191863,   -0.0021142730932622667,   -0.13798708842206597,   0.99043115916573576,   2.8144153674247718e-14,   5.2233067694842724e-06,
     0.36261924244291266,   -0.66642493082374565,   -0.64496396760996733,   -0.091682236327230798,   0,   -0.0009719123113295121,
     -0.37390361904382918,   0.53614350171547009,   -0.74960434819245492,   -0.10287497713225179,   0,   0.016009043856649988,
     0.82903780660340376,   0.5061209418556829,   -0.05542732900028581,   -0.0075621032129045895,   0,   -0.23110286288193188,
     0.20346614385162476,   0.11074781807892625,   -0.0014752235318803405,   -0.0002004262735275075,   0,   0.97279711792426027;

    m_Gamma_aug[4] <<
0.20915578397865517,
     0.11384472264395505,
     -0.0015164760510682331,
     -0.00020603090802239838,
     0,
     1;

/////////////////////////////////////////////////////////////// v5 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[5] <<   
0.7262874164662072,   -0.30181020860981117,   0,   0,   0,   1.373588612329929,
     -0.015501582683001705,   0.79498762125540945,   0,   0,   0,   0.84250971947382425,
     -0.024222779253526019,   -0.14700627757132642,   1,   0.3333333,   0.055555544444445,   -0.097018925559809441,
     0.00025549189638565906,   -0.026789999049069205,   0,   1,   0.3333333,   -0.013248668570678732,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    // q=10
    m_K2c[5] <<
-0.0061308223576399951,   -0.11845178949184768,   0.11377215524907505,   0.66977811604181159,   -1.0289642996277786e-14,   -0.12147733645145274; // Q = 10
//-0.63522128039691028,   -0.43222747563713443,   -1.3136448099423239,   -0.046596736146638111,   -0.2393966050959451; // Q = 5        

    m_T[5] <<
-7.0832283181193612e-17,   1.2578100453547458e-16,   -2.0261570199409107e-15,   1.5626389071599078e-14,   0.99999999999999989,   1.4042218078700198e-20,
     -0.00040972610173876386,   0.00064900981655439331,   -0.13546257174334392,   0.99078216706162126,   -1.5876189252139739e-14,   3.6998752411096112e-07,
     0.37280613205864871,   -0.68103061996715186,   -0.62451921701040713,   -0.084785776383048239,   0,   -4.7691274676855623e-05,
     -0.37048473284885353,   0.51347834487015087,   -0.7668027917427801,   -0.10532903358740887,   0,   0.00057038087746111288,
     0.85071766692891115,   0.52204074775696274,   -0.06032510103982925,   -0.0082379754380754507,   0,   -0.0067769315768774546,
     0.0059944912156975061,   0.0032125510386872978,   -1.1834583495537188e-06,   -1.6065178268563998e-07,   0,   0.99997687252729139;
  
 
    m_Gamma_aug[5] <<
0.0059946298563357753,
     0.0032126253385921389,
     -1.1834857205874227e-06,
     -1.6065549824129106e-07,
     0,
     1;
    
/////////////////////////////////////////////////////////////// v6 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[6] <<   
0.80722327763050883,   -0.22058551878751234,   0,   0,   0,   0.99242396510702502,
     -0.0113297183481894,   0.85743453583823359,   0,   0,   0,   0.58198729518733427,
     -0.017325353098857531,   -0.1016919646208735,   1,   0.22222220000000001,   0.024691353086420002,   -0.044442315421240525,
     0.00012060545680407168,   -0.01853239701015548,   0,   1,   0.22222220000000001,   -0.0060587186579759492,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    // q=7.5  
    m_K2c[6] <<
-0.0069499223627139395,   -0.11625046093883928,   0.11761057372081343,   0.65929968993887733,   7.3719559630925832e-15,   -0.080706816533590797; // Q = 7.5
//-0.46554971227596326,   -0.4654602657211161,   -0.96898250924162621,   -0.024911592813389019,   -0.12797956522986562; // Q = 2.5    

    m_T[6] <<
1.1167282376600696e-17,   -2.2551405187698492e-17,   1.5924761509467089e-15,   -1.1796119636642288e-14,   1.0000000000000002,   -6.1343714226932532e-21,
     0.001535574494182731,   -0.0029006795906469864,   -0.13870282297732231,   0.99032860958722224,   1.1574075031717257e-14,   2.1505652247403823e-07,
     0.35687542073507089,   -0.65950899335546942,   -0.65483903427114465,   -0.094200101670768227,   0,   -4.2408411375143366e-05,
     -0.36060065869503793,   0.55605268767886962,   -0.74190614874523586,   -0.10172160689247602,   0,   0.00074472749052158812,
     0.861661930435493,   0.50577034647812713,   -0.039020924189170483,   -0.0053198279160408578,   0,   -0.013569862487935626,
     0.011977423471822179,   0.0064217512929701862,   -4.7319622559160134e-06,   -6.4236886214544964e-07,   0,   0.99990764694270828;
  
    m_Gamma_aug[6] <<
0.011978529725664279,
     0.0064223444161119938,
     -4.7323993074603827e-06,
     -6.4242819235310386e-07,
     0,
     1;
   
/////////////////////////////////////////////////////////////// v7 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[7] <<   
0.80722327763050883,   -0.22058551878751234,   0,   0,   0,   0.77283606014751061,
     -0.0113297183481894,   0.85743453583823359,   0,   0,   0,   0.46214226930288582,
     -0.017325353098857531,   -0.1016919646208735,   1,   0.22222220000000001,   0.024691353086420002,   -0.042577269819010305,
     0.00012060545680407168,   -0.01853239701015548,   0,   1,   0.22222220000000001,   -0.0058053062673806832,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[7] <<
-0.0073185676553992329,   -0.11625092160280709,   0.11962702181045276,   0.66363639987810008,   -5.444348814496887e-15,   -0.065782045248011387; // Q = 7.5
//-0.46477141465361482,   -0.38867121192261134,   -1.0000986318914686,   0.029183424068099584,   -0.079108432008016372; // Q = 2.5
    

    m_T[7] <<
-1.3362791775883842e-17,   2.1575623232461538e-17,   -1.1726730697603216e-15,   8.6874951676918499e-15,   0.99999999999999978,   1.1678466760268666e-19,
     0.0010492517168743556,   -0.0020210492527961378,   -0.13790335818657151,   0.99044307165814804,   -8.4932061383824475e-15,   5.9992648487241122e-06,
     0.36330336963558324,   -0.66721083835898476,   -0.64380718506100054,   -0.09138620020945612,   0,   -0.0011089016363953022,
     -0.37552058315710063,   0.53373082489273027,   -0.75045150994113485,   -0.1030015587937559,   0,   0.018135829118172263,
     0.82271425147770949,   0.50502535535281445,   -0.057569391375374479,   -0.0078551101902204542,   0,   -0.25439086714503639,
     0.22390871515661859,   0.12209180785911643,   -0.0018079459163483384,   -0.00024565342611687375,   0,   0.96693078796600651;
  

    m_Gamma_aug[7] <<
0.23156643468517862,
     0.12626737030056043,
     -0.0018697780015376846,
     -0.00025405481878761928,
     0,
     1;
	 
/////////////////////////////////////////////////////////////// v8 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[8] <<   
0.65410859174809333,   -0.36719940738768858,   0,   0,   0,   1.4482412201569606,
     -0.018860104172713662,   0.73769315504767896,   0,   0,   0,   0.95218674363756006,
     -0.030131838886051653,   -0.18918275513743205,   1,   0.44444440000000002,   0.098765412345680009,   -0.16551497805644361,
     0.00042792782738746815,   -0.034449318055785751,   0,   1,   0.44444440000000002,   -0.022635390283567185,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[8] <<
-0.0049735071371884293,   -0.11613546440327671,   0.10434414091607007,   0.65748760418871277,   2.317607166502195e-15,   -0.14033020536931853; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[8] <<
3.2255014631443757e-17,   -5.4535369276020873e-17,   4.1286418728248009e-16,   -3.3584246494910985e-15,   0.99999999999999989,   -3.7438856268640075e-19,
     -0.0031673766116588034,   0.0055091253207395644,   -0.13152078163052688,   0.99129304409352037,   3.6359804056473877e-15,   4.4662035550290197e-05,
     0.39692857362505302,   -0.70524025690045622,   -0.58297554547777941,   -0.072159024332303395,   0,   -0.0040590724623977472,
     -0.40019503255252831,   0.44234099920940551,   -0.79433429341475825,   -0.1091277297505287,   0,   0.036090791671531147,
     0.79364308480471069,   0.53976192653860955,   -0.10895519012220706,   -0.014907990462976268,   0,   -0.25825227001283246,
     0.22893725128804188,   0.12488928161748818,   -0.0018958441105415562,   -0.00025760252964645935,   0,   0.96539460415199574;
  

    m_Gamma_aug[8] <<
0.2371437030033339,
     0.12936604480733671,
     -0.001963802265299451,
     -0.00026683651279855438,
     0,
     1;
}
// destructor
lateralController::~lateralController(){}

// class methods
void lateralController::compute_steering_angles(long double the_yL, int the_it_counter, int the_pipe_version) {
    m_z3 = the_yL;
    m_z5 = 2 * m_z3 / ( pow( m_LL + m_l_r, 2 ) );   // curvature calculate

    Matrix<long double, 6, 1> zt_temp, zt;       // zt is the transferred state vector
    if (the_it_counter == 0){
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;
    } else {
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1];
    }

    // zt = m_T[the_pipe_version] * zt_temp;        

    // Matrix<long double, 6, 1> zt_temp_2;
    // zt_temp_2 << zt[1], 
    //              zt[2], 
    //              zt[3], 
    //              zt[4], 
    //              zt[5],
    //              zt[6];

    // calculate the desired steering angle 
    m_desired_steering_angle = m_K2c[the_pipe_version] * zt_temp;   
    // calculate left front tire steering angle according to desired steering angle                     
    m_steering_angle_left    = atan( m_l / (-m_d + m_l / tan(m_desired_steering_angle) ) );  
    // calculate right front tire steering angle according to desired steering angle 
    m_steering_angle_right   = atan( m_l / ( m_d + m_l / tan(m_desired_steering_angle) ) );         
}

long double lateralController::get_steering_angles() {
    // return steering angles
    long double steering_angles = 0.0L;
    steering_angles =  m_desired_steering_angle;
    // steering_angles[0] = m_steering_angle_left;
    // steering_angles[1] = m_steering_angle_right;
    return steering_angles;       
}

void lateralController::estimate_next_state(int the_it_counter, int the_pipe_version) {
    // transfer state vector
    Matrix<long double, 6, 1> zkp_temp, zkp;  
    if (the_it_counter == 0){
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;       
    } else {
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1]; 
    }

    // given the control design, estimate next states
    zkp = m_phi_aug[the_pipe_version]   * zkp_temp + 
          m_Gamma_aug[the_pipe_version] * m_desired_steering_angle;  

        m_z1 = zkp[0];
        m_z2 = zkp[1];
        m_z4 = zkp[3];
        m_z5 = zkp[4];
        m_input[the_it_counter+1] = m_desired_steering_angle;
}

vector<long double> lateralController::get_steering_angle_left_container(){
    return m_steering_angle_left_container;
}

vector<long double> lateralController::get_steering_angle_right_container(){
    return m_steering_angle_right_container;
}

