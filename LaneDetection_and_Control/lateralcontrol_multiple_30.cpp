#include <Eigen/Eigen>
#include "config.hpp"

using namespace std;
using namespace Eigen;

// constructor
lateralController30::lateralController30() {
    // initialize member variables 
    // m_d   = 0.135L;   // 2*d = distance between left and right wheels
    // m_l   = 0.42L;    // l = distance between front and read wheels 
    // m_vx  = 2.2L;     // vehicle longitudinal speed is 2.2m/s to simulate ~80km/h in reality
    // m_LL  = 0.55L;    // look-ahead distance is 0.25s*vx
    // m_l_r = 0.21L;    // distance from CG to rear axle (m)
    m_d   = 1.628L;   // 2*d = distance between left and right wheels  
    m_l   = 2.995L;    // l = distance between front and rear wheels 
    m_vx  = 8.333333L;     // vehicle longitudinal speed is 5.55556m/s (20 km/hr)
    m_LL  = 5.5L;    // look-ahead distance is 0.25s*vx
    m_l_r = 1.2975L;    // distance from CG to rear axle (m)
    m_z1    = 0.0L;         // z1 is vy
    m_z2    = 0.0L;         // z2 is yaw rate
    m_z3    = 0.0L;         // z3 is yL
    m_z4    = 0.0L;         // z4 is epsilon_L
    m_z5    = 0.0L;         // z5 is curvature at lookahead distance KL (which is K_ref of CoG)
    fill(m_input.begin(), m_input.end(), 0.0L); // m_input is the input of the last sampling period.

    m_desired_steering_angle = 0.0L;
    m_steering_angle_left    = 0.0L;
    m_steering_angle_right   = 0.0L;

    // controller design time parameters
    // Eigen::Matrix<typename Scalar, int RowsAtCompileTime, int ColsAtCompileTime>
	///// VALUES ARE CONSIDERING ACTUATE DELAY //////////
/////////////////////////////////////////////////////////////// v0 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[0] <<   
0.52883986941906702,   -0.29038154325852811,   0,   0,   0,   1.7386917275101677,
     -0.023535441051300791,   0.63314467835974142,   0,   0,   0,   1.1205892255645273,
     -0.029602119818158964,   -0.19770419532932151,   1,   0.375,   0.0703125,   -0.19982701874114689,
     0.00064166535162837207,   -0.036062865234988119,   0,   1,   0.375,   -0.027427760169868778,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    m_K2c[0] <<
-0.0087759137743595728,   -0.13960481778763009,   0.20308410600045956,   0.79301628412805103,   3.2822753403311005e-15,   -0.21642718567871738; // Q = 7.5, R=200 
// -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
// -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
//-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.5
   

    m_T[0] <<
4.3368086899420177e-17,   -7.7303614898216466e-17,   5.5164206536062466e-16,   -4.3853809472693683e-15,   1,   0,
     -0.0025653668456825703,   0.0043380275080864023,   -0.13401209377211215,   0.99096688094663421,   4.3298697960381105e-15,   0,
     0.42316173734810164,   -0.74847417330716381,   -0.50656447117785897,   -0.06413261632734335,   0,   0,
     -0.34793531194507088,   0.38607610391968056,   -0.84627937097314876,   -0.11703626339377926,   0,   0,
     0.8365814853552338,   0.53917792554192812,   -0.096147914841677562,   -0.013197023934619119,   0,   0,
     0,   0,   0,   0,   0,   1;
   
    
    m_Gamma_aug[0] <<
0,
     0,
     -0,
     -0,
     0,
     1;
	 
/////////////////////////////////////////////////////////////// v1 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[1] <<   
0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
     -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
     -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
     0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[1] <<
-0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[1] <<
3.4098158324669114e-17,   -6.1636893505800927e-17,   3.219646771412954e-15,   -2.3731017151362721e-14,   1,   0,
     0.0015533316542140085,   -0.0029689688209718415,   -0.13906958325936095,   0.99027694277761513,   2.4036328483134639e-14,   0,
     0.3845891046548669,   -0.70499904245893208,   -0.58970485899267744,   -0.085532157655370922,   0,   0,
     -0.33883178195950003,   0.49263688584016346,   -0.79404715808403414,   -0.10950357520430216,   0,   0,
     0.8586511697282484,   0.51017294525075974,   -0.048958564431189532,   -0.0066928041442083424,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[1] <<
  0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// v2 ////////////////////////////////////////////////////////////////////////////
  m_phi_aug[3] <<   
0.52883986941906702,   -0.29038154325852811,   0,   0,   0,   1.7386917275101677,
     -0.023535441051300791,   0.63314467835974142,   0,   0,   0,   1.1205892255645273,
     -0.029602119818158964,   -0.19770419532932151,   1,   0.375,   0.0703125,   -0.19982701874114689,
     0.00064166535162837207,   -0.036062865234988119,   0,   1,   0.375,   -0.027427760169868778,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

    m_K2c[3] <<
-0.0087759137743595728,   -0.13960481778763009,   0.20308410600045956,   0.79301628412805103,   3.2822753403311005e-15,   -0.21642718567871738; // Q = 7.5, R=200 
// -0.48402097619111417,   -0.42376985807359507,   -1.3360755825434583,   0.08540893033116069,   -0.25517460395887159; // Q = 5
// -2.1195710428629027,   -1.6001839119866061,   -3.5343931650567462,   0.21146444275696266,   -0.64888135178617723;  // Q = 100
//-0.29498618074169913,   -0.28483932006375978,   -1.0551617243483074,   0.068797172806382811,   -0.20401339097820362; // Q = 2.5
   

    m_T[3] <<
4.3368086899420177e-17,   -7.7303614898216466e-17,   5.5164206536062466e-16,   -4.3853809472693683e-15,   1,   0,
     -0.0025653668456825703,   0.0043380275080864023,   -0.13401209377211215,   0.99096688094663421,   4.3298697960381105e-15,   0,
     0.42316173734810164,   -0.74847417330716381,   -0.50656447117785897,   -0.06413261632734335,   0,   0,
     -0.34793531194507088,   0.38607610391968056,   -0.84627937097314876,   -0.11703626339377926,   0,   0,
     0.8365814853552338,   0.53917792554192812,   -0.096147914841677562,   -0.013197023934619119,   0,   0,
     0,   0,   0,   0,   0,   1;
   
    
    m_Gamma_aug[3] <<
0,
     0,
     -0,
     -0,
     0,
     1;
  
/////////////////////////////////////////////////////////////// v3 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[3] <<   
0.52883986806157912,   -0.29038154205146549,   0,   0,   0,   1.490626892021268,
     -0.023535441093393623,   0.63314467718880141,   0,   0,   0,   0.98529260456011958,
     -0.02960211977081793,   -0.19770419515258555,   1,   0.37499999849999993,   0.070312499437499995,   -0.19765847703130213,
     0.00064166535329202902,   -0.036062865204078136,   0,   1,   0.37499999849999999,   -0.027132986534157869,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;


    // q=7.5
    m_K2c[3] <<
-0.0085833529640744061,   -0.13588107905249372,   0.19723754451439496,   0.77794040475457726,   1.0943616212619361e-15,   -0.19130406236218295; // Q = 7.5
//-0.29249027996323107,   -0.28549560532646351,   -1.056563344205941,   0.079929179840173781,   -0.18633734617443931; // Q = 2.5
    
    m_T[3] <<
1.5070410197548512e-17,   -2.7863995832877464e-17,   1.9775847626135601e-16,   -1.5543122344752192e-15,   1,   -2.9137933385547932e-19,
     -0.0032916389883717026,   0.005497699966243867,   -0.13337336135364644,   0.99104514587857995,   1.4710455076283324e-15,   7.5627941355840988e-05,
     0.43321442849705394,   -0.75336519889803,   -0.4909859397516797,   -0.060457571906925689,   0,   -0.0066200450588938392,
     -0.36626902860667032,   0.35351266497748463,   -0.85164964453202285,   -0.11779445182658869,   0,   0.041147836776626215,
     0.78814679848388691,   0.53896919805309584,   -0.12582877874945342,   -0.017285470255477355,   0,   -0.26871017573971817,
     0.23871750412960235,   0.13019850857414939,   -0.0020868287639242162,   -0.00028366625436621409,   0,   0.96231900441920326;

  

    m_Gamma_aug[3] <<
0.24806483404500307,
     0.13529661991111691,
     -0.0021685415692104075,
     -0.00029477361775414343,
     0,
     1;
   
/////////////////////////////////////////////////////////////// v4 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[4] <<   
0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
     -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
     -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
     0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[4] <<
-0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[4] <<
3.4098158324669114e-17,   -6.1636893505800927e-17,   3.219646771412954e-15,   -2.3731017151362721e-14,   1,   0,
     0.0015533316542140085,   -0.0029689688209718415,   -0.13906958325936095,   0.99027694277761513,   2.4036328483134639e-14,   0,
     0.3845891046548669,   -0.70499904245893208,   -0.58970485899267744,   -0.085532157655370922,   0,   0,
     -0.33883178195950003,   0.49263688584016346,   -0.79404715808403414,   -0.10950357520430216,   0,   0,
     0.8586511697282484,   0.51017294525075974,   -0.048958564431189532,   -0.0066928041442083424,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[4] <<
  0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// v5 ////////////////////////////////////////////////////////////////////////////
 m_phi_aug[5] <<   
0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
     -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
     -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
     0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[5] <<
-0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[5] <<
3.4098158324669114e-17,   -6.1636893505800927e-17,   3.219646771412954e-15,   -2.3731017151362721e-14,   1,   0,
     0.0015533316542140085,   -0.0029689688209718415,   -0.13906958325936095,   0.99027694277761513,   2.4036328483134639e-14,   0,
     0.3845891046548669,   -0.70499904245893208,   -0.58970485899267744,   -0.085532157655370922,   0,   0,
     -0.33883178195950003,   0.49263688584016346,   -0.79404715808403414,   -0.10950357520430216,   0,   0,
     0.8586511697282484,   0.51017294525075974,   -0.048958564431189532,   -0.0066928041442083424,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[5] <<
  0,
     0,
     -0,
     -0,
     0,
     1;
    
/////////////////////////////////////////////////////////////// v6 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[6] <<   
0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
     -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
     -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
     0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[6] <<
-0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[6] <<
3.4098158324669114e-17,   -6.1636893505800927e-17,   3.219646771412954e-15,   -2.3731017151362721e-14,   1,   0,
     0.0015533316542140085,   -0.0029689688209718415,   -0.13906958325936095,   0.99027694277761513,   2.4036328483134639e-14,   0,
     0.3845891046548669,   -0.70499904245893208,   -0.58970485899267744,   -0.085532157655370922,   0,   0,
     -0.33883178195950003,   0.49263688584016346,   -0.79404715808403414,   -0.10950357520430216,   0,   0,
     0.8586511697282484,   0.51017294525075974,   -0.048958564431189532,   -0.0066928041442083424,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[6] <<
  0,
     0,
     -0,
     -0,
     0,
     1;
   
/////////////////////////////////////////////////////////////// v7 ////////////////////////////////////////////////////////////////////////////
m_phi_aug[7] <<   
0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
     -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
     -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
     0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[7] <<
-0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[7] <<
3.4098158324669114e-17,   -6.1636893505800927e-17,   3.219646771412954e-15,   -2.3731017151362721e-14,   1,   0,
     0.0015533316542140085,   -0.0029689688209718415,   -0.13906958325936095,   0.99027694277761513,   2.4036328483134639e-14,   0,
     0.3845891046548669,   -0.70499904245893208,   -0.58970485899267744,   -0.085532157655370922,   0,   0,
     -0.33883178195950003,   0.49263688584016346,   -0.79404715808403414,   -0.10950357520430216,   0,   0,
     0.8586511697282484,   0.51017294525075974,   -0.048958564431189532,   -0.0066928041442083424,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[7] <<
  0,
     0,
     -0,
     -0,
     0,
     1;
	 
/////////////////////////////////////////////////////////////// v8 ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[8] <<   
0.56698856654140162,   -0.27433108361455039,   0,   0,   0,   1.6198035123738834,
     -0.022234550359150965,   0.665528063720906,   0,   0,   0,   1.0231332751670421,
     -0.027517940171709075,   -0.17982892253316662,   1,   0.33333333333333337,   0.055555555555555566,   -0.16090650342033347,
     0.00052714004699310195,   -0.03281691348572887,   0,   1,   0.33333333333333337,   -0.022066123084759325,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[8] <<
-0.0099086967229825712,   -0.14093836446392632,   0.2133815240076401,   0.79886816083652101,   6.4324137571467438e-15,   -0.19715482623597491; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[8] <<
6.4618449480136064e-17,   -1.153049010438334e-16,   1.1102230246251565e-15,   -8.6042284408449632e-15,   1.0000000000000002,   0,
     -0.0014245609333720678,   0.0023512180014169152,   -0.13526573521149532,   0.99080554261557852,   8.4376949871511897e-15,   0,
     0.41359326565801896,   -0.73917255407779259,   -0.52699225576467823,   -0.069596754698075872,   0,   0,
     -0.34529254991267067,   0.41287416740926808,   -0.83485269092527092,   -0.11545112089427086,   0,   0,
     0.84244384750752888,   0.53212153589018207,   -0.083685887081297025,   -0.011476373207671206,   0,   0,
     0,   0,   0,   0,   0,   1;
  

    m_Gamma_aug[8] <<
0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// no classifier ////////////////////////////////////////////////////////////////////////////
m_phi_aug[9] <<   
0.69997596089878256,   -0.2059865223212165,   0,   0,   0,   1.1689992028409117,
     -0.01669521967219955,   0.77396614847740541,   0,   0,   0,   0.69456816380729802,
     -0.019723532786826346,   -0.12077000851293093,   1,   0.20833333333333334,   0.021701388888888895,   -0.066653985704589788,
     0.00023182788300832704,   -0.022042947105171802,   0,   1,   0.20833333333333337,   -0.0091118290933279167,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;

// // v1 q=7.5
    m_K2c[9] <<
-0.014109377520501301,   -0.14262405135922163,   0.2468286806575069,   0.80963015545776196,   1.8455892053601368e-14,   -0.13196848577749484; // Q = 10, R-=200
//-0.42875437936449812,   -0.3169739912062795,   -1.0294664428425566,   0.04057357149091402,   -0.093311658910749912; // Q = 2.5      

    m_T[9] <<
3.4098158324669114e-17,   -6.1636893505800927e-17,   3.219646771412954e-15,   -2.3731017151362721e-14,   1,   0,
     0.0015533316542140085,   -0.0029689688209718415,   -0.13906958325936095,   0.99027694277761513,   2.4036328483134639e-14,   0,
     0.3845891046548669,   -0.70499904245893208,   -0.58970485899267744,   -0.085532157655370922,   0,   0,
     -0.33883178195950003,   0.49263688584016346,   -0.79404715808403414,   -0.10950357520430216,   0,   0,
     0.8586511697282484,   0.51017294525075974,   -0.048958564431189532,   -0.0066928041442083424,   0,   0,
     0,   0,   0,   0,   0,   1;
   

    m_Gamma_aug[9] <<
  0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// 1 classifier ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[10] <<   
0.60806805654952334,   -0.25514844806760095,   0,   0,   0,   1.4862100260130235,
     -0.020679796627017692,   0.69971716698732711,   0,   0,   0,   0.91990185300303984,
     -0.025191951682377599,   -0.16108926163927895,   1,   0.29166666666666669,   0.042534722222222245,   -0.1255882807656688,
     0.000419742819967695,   -0.029404575461172356,   0,   1,   0.29166666666666674,   -0.017206051800215522,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[10] <<
-0.011167119216029045,   -0.14191729279390985,   0.22410668326466493,   0.80365399906255219,   1.0346817860725014e-14,   -0.17665087187627446; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[10] <<
7.1862275245054841e-17,   -1.2666191880061906e-16,   1.7347234759768071e-15,   -1.3267165144270621e-14,   1,   0,
     -0.00036142507592584191,   0.00047389852483826822,   -0.13652668352236427,   0.99063621449979633,   1.3516965324811281e-14,   0,
     0.40397071812637758,   -0.72883924278757617,   -0.54770247639651115,   -0.074986761621104681,   0,   0,
     -0.34290190167723045,   0.43960332875408276,   -0.8223422164286488,   -0.11366828165185776,   0,   0,
     0.84807182130672887,   0.52492099114185775,   -0.071664085250080403,   -0.0098182406472198201,   0,   0,
     0,   0,   0,   0,   0,   1;
  

    m_Gamma_aug[10] <<
0,
     0,
     -0,
     -0,
     0,
     1;

/////////////////////////////////////////////////////////////// 2 classifier ////////////////////////////////////////////////////////////////////////////
    m_phi_aug[11] <<   
0.56698856654140162,   -0.27433108361455039,   0,   0,   0,   1.6198035123738834,
     -0.022234550359150965,   0.665528063720906,   0,   0,   0,   1.0231332751670421,
     -0.027517940171709075,   -0.17982892253316662,   1,   0.33333333333333337,   0.055555555555555566,   -0.16090650342033347,
     0.00052714004699310195,   -0.03281691348572887,   0,   1,   0.33333333333333337,   -0.022066123084759325,
     0,   0,   0,   0,   1,   0,
     0,   0,   0,   0,   0,   0;
    
    // q=7.5
    m_K2c[11] <<
-0.0099086967229825712,   -0.14093836446392632,   0.2133815240076401,   0.79886816083652101,   6.4324137571467438e-15,   -0.19715482623597491; // Q = 7.5
//-0.28614679486699318,   -0.28802685785999194,   -1.0593314709112267,   0.080818517814108204,   -0.15246689570600142; // Q = 2.5
    

    m_T[11] <<
6.4618449480136064e-17,   -1.153049010438334e-16,   1.1102230246251565e-15,   -8.6042284408449632e-15,   1.0000000000000002,   0,
     -0.0014245609333720678,   0.0023512180014169152,   -0.13526573521149532,   0.99080554261557852,   8.4376949871511897e-15,   0,
     0.41359326565801896,   -0.73917255407779259,   -0.52699225576467823,   -0.069596754698075872,   0,   0,
     -0.34529254991267067,   0.41287416740926808,   -0.83485269092527092,   -0.11545112089427086,   0,   0,
     0.84244384750752888,   0.53212153589018207,   -0.083685887081297025,   -0.011476373207671206,   0,   0,
     0,   0,   0,   0,   0,   1;
  

    m_Gamma_aug[11] <<
0,
     0,
     -0,
     -0,
     0,
     1;
}
// destructor
lateralController30::~lateralController30(){}

// class methods
void lateralController30::compute_steering_angles(long double the_yL, int the_it_counter, int the_pipe_version) {
    m_z3 = the_yL;
    m_z5 = 2 * m_z3 / ( pow( m_LL + m_l_r, 2 ) );   // curvature calculate

    Matrix<long double, 6, 1> zt_temp, zt;       // zt is the transferred state vector
    if (the_it_counter == 0){
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;
    } else {
        zt_temp <<  m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1];
    }

    // zt = m_T[the_pipe_version] * zt_temp;        

    // Matrix<long double, 6, 1> zt_temp_2;
    // zt_temp_2 << zt[1], 
    //              zt[2], 
    //              zt[3], 
    //              zt[4], 
    //              zt[5],
    //              zt[6];

    // calculate the desired steering angle 
    m_desired_steering_angle = m_K2c[the_pipe_version] * zt_temp;   
    // calculate left front tire steering angle according to desired steering angle                     
    m_steering_angle_left    = atan( m_l / (-m_d + m_l / tan(m_desired_steering_angle) ) );  
    // calculate right front tire steering angle according to desired steering angle 
    m_steering_angle_right   = atan( m_l / ( m_d + m_l / tan(m_desired_steering_angle) ) );         
}

long double lateralController30::get_steering_angles() {
    // return steering angles
    long double steering_angles = 0.0L;
    steering_angles =  m_desired_steering_angle;
    // steering_angles[0] = m_steering_angle_left;
    // steering_angles[1] = m_steering_angle_right;
    return steering_angles;       
}

void lateralController30::estimate_next_state(int the_it_counter, int the_pipe_version) {
    // transfer state vector
    Matrix<long double, 6, 1> zkp_temp, zkp;  
    if (the_it_counter == 0){
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    0.0L;       
    } else {
        zkp_temp << m_z1,
                    m_z2,
                    m_z3,
                    m_z4,
                    m_z5,
                    m_input[the_it_counter-1]; 
    }

    // given the control design, estimate next states
    zkp = m_phi_aug[the_pipe_version]   * zkp_temp + 
          m_Gamma_aug[the_pipe_version] * m_desired_steering_angle;  

        m_z1 = zkp[0];
        m_z2 = zkp[1];
        m_z4 = zkp[3];
        m_z5 = zkp[4];
        m_input[the_it_counter+1] = m_desired_steering_angle;
}

vector<long double> lateralController30::get_steering_angle_left_container(){
    return m_steering_angle_left_container;
}

vector<long double> lateralController30::get_steering_angle_right_container(){
    return m_steering_angle_right_container;
}

